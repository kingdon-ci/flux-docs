"use strict";(self.webpackChunkweave_gitops_docs=self.webpackChunkweave_gitops_docs||[]).push([[9228],{19666:(e,t,i)=>{i.d(t,{Z:()=>n});var l=i(67294),o=i(5730);function n(e){let{children:t,fallback:i}=e;return(0,o.Z)()?l.createElement(l.Fragment,null,t?.()):i??null}},16420:(e,t,i)=>{i.d(t,{Z:()=>a});var l=i(67294),o=i(88746);i(52426);const n={fontSize:16,marginLeft:4,fontVariant:"all-small-caps"};function a(e){let{tiers:t}=e;return l.createElement(o.Z,{title:`This feature is a available on ${t}`,style:n},t)}},70075:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var l=i(87462),o=(i(67294),i(3905)),n=i(16420);i(77823),i(19666);const a={title:"Getting Started",hide_title:!0},s='Getting started <TierLabel tiers="enterprise" />',r={unversionedId:"policy/getting-started",id:"version-0.16.0/policy/getting-started",title:"Getting Started",description:"This section introduces you to the Policy Profile and details the steps required to install it in Weave GitOps.",source:"@site/versioned_docs/version-0.16.0/policy/getting-started.mdx",sourceDirName:"policy",slug:"/policy/getting-started",permalink:"/docs/0.16.0/policy/getting-started",draft:!1,editUrl:"https://github.com/weaveworks/weave-gitops/edit/main/website/versioned_docs/version-0.16.0/policy/getting-started.mdx",tags:[],version:"0.16.0",frontMatter:{title:"Getting Started",hide_title:!0},sidebar:"docs",previous:{title:"Introduction",permalink:"/docs/0.16.0/policy/intro"},next:{title:"Weave Policy Profile",permalink:"/docs/0.16.0/policy/weave-policy-profile"}},p={},c=[{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"Weave GitOps",id:"weave-gitops",level:3},{value:"Policy Library",id:"policy-library",level:3},{value:"Install agent on management cluster",id:"install-agent-on-management-cluster",level:2},{value:"Install Policy Profile",id:"install-policy-profile",level:2},{value:"Policies in UI",id:"policies-in-ui",level:2},{value:"Prevent Violating Changes",id:"prevent-violating-changes",level:2},{value:"Violations Logs in UI",id:"violations-logs-in-ui",level:2}],d={toc:c};function u(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,l.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"getting-started-"},"Getting started ",(0,o.kt)(n.Z,{tiers:"enterprise",mdxType:"TierLabel"})),(0,o.kt)("p",null,"This section introduces you to the Policy Profile and details the steps required to install it in Weave GitOps."),(0,o.kt)("h2",{id:"pre-requisites"},"Pre-requisites"),(0,o.kt)("h3",{id:"weave-gitops"},"Weave GitOps"),(0,o.kt)("p",null,"You need to have a running instance of Weave GitOps with at least one CAPI provider installed to provision Kubernetes clusters. See ",(0,o.kt)("a",{parentName:"p",href:"https://docs.gitops.weave.works/docs/installation/"},"Weave GitOps Installation")," page for more details about installing Weave GitOps."),(0,o.kt)("h3",{id:"policy-library"},"Policy Library"),(0,o.kt)("p",null,"For the policy agent to work, it will need a source for the policies that it will enforce in the cluster. You should have a policy library repo set up which includes your policies resources as CRDs. You can also add a ",(0,o.kt)("inlineCode",{parentName:"p"},"kustomization.yaml")," file selecting the policies you want to install on that specific cluster that will be provisioned by Weave Gitops:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n- policies/<policy1.yaml>\n- policies/<policy2.yaml>\n- policies/<policy3.yaml>\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Enterprise customers should have access to fork policy library repo into their local repositories. ")),(0,o.kt)("h2",{id:"install-agent-on-management-cluster"},"Install agent on management cluster"),(0,o.kt)("p",null,"The agent comes packaged with the WGE chart. To install it you need to set the following values:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"values.policy-agent.enabled"),": set to true to install the agent with WGE"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"values.policy-agent.accountId"),": organization name, used as identifier"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"values.policy-agent.clusterId"),": unique identifier for the cluster")),(0,o.kt)("h2",{id:"install-policy-profile"},"Install Policy Profile"),(0,o.kt)("p",null,"To install the policy profile on a cluster, you should select the ",(0,o.kt)("inlineCode",{parentName:"p"},"weave-policy-agent")," from the profiles dropdown in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Create Cluster")," page. "),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Policy Profile",src:i(51166).Z,width:"1650",height:"364"})),(0,o.kt)("p",null,"You should then configure the ",(0,o.kt)("inlineCode",{parentName:"p"},"values.yaml"),". You can find more about the policy profile configurations ",(0,o.kt)("a",{parentName:"p",href:"../weave-policy-profile/"},"here"),"."),(0,o.kt)("em",null,(0,o.kt)("strong",null,"Add or link to profile config")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"policySource:\n  url: URL of the repo where your policies exist\n  tag: tag name on the policies repo\n  path: Path to the policies dir - or a kustomization.yaml that selects some policies - in the repo\n  secretRef (if the repo is private): Name of the K8s secret with private repo credentials (leave empty if the repo is public)\n")),(0,o.kt)("h2",{id:"policies-in-ui"},"Policies in UI"),(0,o.kt)("p",null,"After the leaf cluster is provisioned and the profile is installed, you should now see the policies listed in the Policies tab in Weave GitOps UI."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Policies",src:i(51832).Z,width:"3356",height:"1882"})),(0,o.kt)("p",null,"Now you have a provisioned cluster with these policies enforced by the policy agent."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"By default, the policy profile is set up to enforce policies at deployment time using admission controller, which results in blocking any deployment that violates the enforced policies.")),(0,o.kt)("h2",{id:"prevent-violating-changes"},"Prevent Violating Changes"),(0,o.kt)("p",null,"Now let's try to deploy a Kubernetes deployment that violates one of the enforced policies. Let's deploy a deployment that has ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.securityContext.allowPrivilegeEscalation")," as ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),". This violates the ",(0,o.kt)("inlineCode",{parentName:"p"},"Allow Privilege Escalation")," policy."),(0,o.kt)("p",null,"Once you apply it, the policy agent will deny this request and show a violation message."),(0,o.kt)("h2",{id:"violations-logs-in-ui"},"Violations Logs in UI"),(0,o.kt)("p",null,"You can view all the violation log in Weave GitOps UI to view all connected clusters policy violations, and where you can dive into the details of each violation. "),(0,o.kt)("strong",null,"Violations Log"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Violations Logs",src:i(95127).Z,width:"3360",height:"1880"})),(0,o.kt)("strong",null,"Violations Log Details"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Violation Log Details",src:i(3605).Z,width:"3360",height:"2972"})))}u.isMDXComponent=!0},3605:(e,t,i)=>{i.d(t,{Z:()=>l});const l=i.p+"assets/images/violations-log-detail-644dce8dc57662d17e64817ed300ade6.png"},95127:(e,t,i)=>{i.d(t,{Z:()=>l});const l=i.p+"assets/images/violations-logs-76fd64e5027509cd16039494f8e4f904.png"},51832:(e,t,i)=>{i.d(t,{Z:()=>l});const l=i.p+"assets/images/weave-policies-79e6dfeda5fb02d06b0f4a5725e77f73.png"},51166:(e,t,i)=>{i.d(t,{Z:()=>l});const l=i.p+"assets/images/weave-policy-profile-1272ded387d15da564a71392c5a1450e.png"}}]);