"use strict";(self.webpackChunkweave_gitops_docs=self.webpackChunkweave_gitops_docs||[]).push([[48607],{32342:(e,t,a)=>{a.d(t,{Z:()=>l});var r=a(67294),n=a(86010);const i="tabItem_Ymn6";function l(e){let{children:t,hidden:a,className:l}=e;return r.createElement("div",{role:"tabpanel",className:(0,n.Z)(i,l),hidden:a},t)}},71125:(e,t,a)=>{a.d(t,{Z:()=>E});var r=a(87462),n=a(67294),i=a(86010),l=a(63735),o=a(16550),s=a(34423),u=a(20636),c=a(99200);function p(e){return function(e){return n.Children.map(e,(e=>{if(!e||(0,n.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:a,attributes:r,default:n}}=e;return{value:t,label:a,attributes:r,default:n}}))}function m(e){const{values:t,children:a}=e;return(0,n.useMemo)((()=>{const e=t??p(a);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,a])}function d(e){let{value:t,tabValues:a}=e;return a.some((e=>e.value===t))}function v(e){let{queryString:t=!1,groupId:a}=e;const r=(0,o.k6)(),i=function(e){let{queryString:t=!1,groupId:a}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:t,groupId:a});return[(0,s._X)(i),(0,n.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(r.location.search);t.set(i,e),r.replace({...r.location,search:t.toString()})}),[i,r])]}function h(e){const{defaultValue:t,queryString:a=!1,groupId:r}=e,i=m(e),[l,o]=(0,n.useState)((()=>function(e){let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=a.find((e=>e.default))??a[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:i}))),[s,u]=v({queryString:a,groupId:r}),[p,h]=function(e){let{groupId:t}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,i]=(0,c.Nk)(a);return[r,(0,n.useCallback)((e=>{a&&i.set(e)}),[a,i])]}({groupId:r}),k=(()=>{const e=s??p;return d({value:e,tabValues:i})?e:null})();(0,n.useLayoutEffect)((()=>{k&&o(k)}),[k]);return{selectedValue:l,selectValue:(0,n.useCallback)((e=>{if(!d({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),h(e)}),[u,h,i]),tabValues:i}}var k=a(5730);const f="tabList__CuJ",b="tabItem_LNqP";function g(e){let{className:t,block:a,selectedValue:o,selectValue:s,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:p}=(0,l.o5)(),m=e=>{const t=e.currentTarget,a=c.indexOf(t),r=u[a].value;r!==o&&(p(t),s(r))},d=e=>{let t=null;switch(e.key){case"Enter":m(e);break;case"ArrowRight":{const a=c.indexOf(e.currentTarget)+1;t=c[a]??c[0];break}case"ArrowLeft":{const a=c.indexOf(e.currentTarget)-1;t=c[a]??c[c.length-1];break}}t?.focus()};return n.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":a},t)},u.map((e=>{let{value:t,label:a,attributes:l}=e;return n.createElement("li",(0,r.Z)({role:"tab",tabIndex:o===t?0:-1,"aria-selected":o===t,key:t,ref:e=>c.push(e),onKeyDown:d,onClick:m},l,{className:(0,i.Z)("tabs__item",b,l?.className,{"tabs__item--active":o===t})}),a??t)})))}function y(e){let{lazy:t,children:a,selectedValue:r}=e;const i=(Array.isArray(a)?a:[a]).filter(Boolean);if(t){const e=i.find((e=>e.props.value===r));return e?(0,n.cloneElement)(e,{className:"margin-top--md"}):null}return n.createElement("div",{className:"margin-top--md"},i.map(((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function w(e){const t=h(e);return n.createElement("div",{className:(0,i.Z)("tabs-container",f)},n.createElement(g,(0,r.Z)({},e,t)),n.createElement(y,(0,r.Z)({},e,t)))}function E(e){const t=(0,k.Z)();return n.createElement(w,(0,r.Z)({key:String(t)},e))}},48717:(e,t,a)=>{a.d(t,{Z:()=>l});var r=a(67294),n=a(88746);a(52426);const i={fontSize:16,marginLeft:4,fontVariant:"all-small-caps"};function l(e){let{tiers:t}=e;return r.createElement(n.Z,{title:`This feature is a available on ${t}.`,style:i},t)}},1338:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>m,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var r=a(87462),n=(a(67294),a(3905)),i=(a(71125),a(32342),a(48717));const l={title:"Commit/Build Time Checks",hide_title:!0},o='Commit/Build time checks  <TierLabel tiers="Enterprise" />',s={unversionedId:"policy/commit-time-checks",id:"version-0.17.0/policy/commit-time-checks",title:"Commit/Build Time Checks",description:"Overview",source:"@site/versioned_docs/version-0.17.0/policy/commit-time-checks.mdx",sourceDirName:"policy",slug:"/policy/commit-time-checks",permalink:"/docs/0.17.0/policy/commit-time-checks",draft:!1,editUrl:"https://github.com/weaveworks/weave-gitops/edit/main/website/versioned_docs/version-0.17.0/policy/commit-time-checks.mdx",tags:[],version:"0.17.0",frontMatter:{title:"Commit/Build Time Checks",hide_title:!0},sidebar:"docs",previous:{title:"Profile Releases",permalink:"/docs/0.17.0/policy/releases"},next:{title:"Using templates",permalink:"/docs/0.17.0/gitops-templates/templates"}},u={},c=[{value:"Overview",id:"overview",level:2},{value:"Usage",id:"usage",level:2},{value:"Setup policies",id:"setup-policies",level:2},{value:"Auto-Remediation",id:"auto-remediation",level:2},{value:"UseCase: Github",id:"usecase-github",level:2},{value:"UseCase: Gitlab",id:"usecase-gitlab",level:2},{value:"Enable Auto Remediation",id:"enable-auto-remediation",level:4},{value:"Enable Static Application Security Testing",id:"enable-static-application-security-testing",level:4},{value:"UseCase: Bitbucket",id:"usecase-bitbucket",level:2},{value:"Enable Auto Remediation",id:"enable-auto-remediation-1",level:4},{value:"Create Pipeline Report",id:"create-pipeline-report",level:4},{value:"UseCase: CircleCI",id:"usecase-circleci",level:2},{value:"Enable Auto Remediation",id:"enable-auto-remediation-2",level:4},{value:"UseCase: Azure DevOps",id:"usecase-azure-devops",level:2},{value:"Enable Auto Remediation",id:"enable-auto-remediation-3",level:4}],p={toc:c};function m(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,r.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"commitbuild-time-checks--"},"Commit/Build time checks  ",(0,n.kt)(i.Z,{tiers:"Enterprise",mdxType:"TierLabel"})),(0,n.kt)("h2",{id:"overview"},"Overview"),(0,n.kt)("p",null,"Weave GitOps Enterprise enable developers and operators to check policy violations early in their software development life cycle, specifically at commit and build time. Developers and operators can have Weave Policy Validator integrated in their CI tools to validate whether their code changes are violating any policies or not. "),(0,n.kt)("p",null,"Weave GitOps Enterprise offer a policy engine image that can be used to perform commit/build time checks.The image can be found on Docker Hub under the name: ",(0,n.kt)("inlineCode",{parentName:"p"},"weaveworks/weave-iac-validator:v1.1"),". "),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"usage"},"Usage"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"USAGE:\n   main [global options] command [command options] [arguments...]\n\nVERSION:\n   0.0.1\n\nCOMMANDS:\n   help, h  Shows a list of commands or help for one command\n\nGLOBAL OPTIONS:\n   --path value                       path to resources kustomization directory\n   --helm-values-file value           path to resources helm values file\n   --policies-path value              path to policies kustomization directory\n   --policies-helm-values-file value  path to policies helm values file\n   --git-repo-provider value          git repository provider [$WEAVE_REPO_PROVIDER]\n   --git-repo-url value               git repository url [$WEAVE_REPO_URL]\n   --git-repo-branch value            git repository branch [$WEAVE_REPO_BRANCH]\n   --git-repo-sha value               git repository commit sha [$WEAVE_REPO_SHA]\n   --git-repo-token value             git repository token [$WEAVE_REPO_TOKEN]\n   --sast value                       save result as gitlab sast format\n   --sarif value                      save result as sarif format\n   --json value                       save result as json format\n   --generate-git-report              generate git report if supported (default: false) [$WEAVE_GENERATE_GIT_PROVIDER_REPORT]\n   --remediate                        auto remediate resources if possible (default: false)\n   --no-exit-error                    exit with no error (default: false)\n   --help, -h                         show help (default: false)\n   --version, -v                      print the version (default: false)\n")),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"setup-policies"},"Setup policies"),(0,n.kt)("p",null,"Policies can be helm chart, kustomize directory or just plain kubernetes yaml files."),(0,n.kt)("p",null,"Example of policies kustomize directory"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"\u2514\u2500\u2500 policies\n    \u251c\u2500\u2500 kustomization.yaml\n    \u251c\u2500\u2500 minimum-replica-count.yaml\n    \u251c\u2500\u2500 privileged-mode.yaml\n    \u2514\u2500\u2500 privilege-escalation.yaml\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"# kustomization.yaml\nkind: Kustomization\napiVersion: kustomize.config.k8s.io/v1beta1\nresources:\n- minimum-replica-count.yaml\n- privilege-escalation.yaml\n- privileged-mode.yaml\n")),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"auto-remediation"},"Auto-Remediation"),(0,n.kt)("p",null,"Weave validator supports auto-remediation functionality which creates a pull request with suggested fixes to remediate the reported violations."),(0,n.kt)("p",null,"Supported in:"),(0,n.kt)("ul",{className:"contains-task-list"},(0,n.kt)("li",{parentName:"ul",className:"task-list-item"},(0,n.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Helm"),(0,n.kt)("li",{parentName:"ul",className:"task-list-item"},(0,n.kt)("input",{parentName:"li",type:"checkbox",checked:!0,disabled:!0})," ","Kustomize"),(0,n.kt)("li",{parentName:"ul",className:"task-list-item"},(0,n.kt)("input",{parentName:"li",type:"checkbox",checked:!0,disabled:!0})," ","Plain kubernetes files")),(0,n.kt)("p",null,"To enable it you need to provide ",(0,n.kt)("inlineCode",{parentName:"p"},"--remediate")," flag and ",(0,n.kt)("inlineCode",{parentName:"p"},"--git-repo-token"),"."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"}," The token must have the permission to create pull request")),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"usecase-github"},"UseCase: Github"),(0,n.kt)("p",null,"See how to setup the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/weaveworks/weave-action"},"Github Action")),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"usecase-gitlab"},"UseCase: Gitlab"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"weave:\n  image:\n    name: weaveworks/weave-iac-validator:v1.1\n  script:\n  - weave-validator --path <path to resources> --policies-path <path to policies>\n")),(0,n.kt)("h4",{id:"enable-auto-remediation"},"Enable Auto Remediation"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"  script:\n  - weave-validator --path <path to resources> --policies-path <path to policies> --git-repo-token $GITLAB_TOKEN --remediate\n")),(0,n.kt)("hr",null),(0,n.kt)("h4",{id:"enable-static-application-security-testing"},"Enable Static Application Security Testing"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'stages:\n  - weave\n  - sast\n\nweave:\n  stage: weave\n  image:\n    name: weaveworks/weave-iac-validator:v1.1\n  script:\n  - weave-validator <path to resources> --policies-path <path to policies> --sast sast.json\n  artifacts:\n    when: on_failure\n    paths:\n    - sast.json\n\nupload_sast:\n  stage: sast\n  when: always\n  script:\n  - echo "creating sast report" \n  artifacts:\n    reports:\n      sast: sast.json\n')),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"usecase-bitbucket"},"UseCase: Bitbucket"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"pipelines:\n  default:\n    - step:\n        name: 'Weaveworks'\n        image: weaveworks/weave-iac-validator:v1.1\n        script:\n          - weave-validator --path <path to resources> --policies-path <path to policies>\n")),(0,n.kt)("h4",{id:"enable-auto-remediation-1"},"Enable Auto Remediation"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"  script:\n    - weave-validator --path <path to resources> --policies-path <path to policies> --git-repo-token $TOKEN --remediate\n")),(0,n.kt)("h4",{id:"create-pipeline-report"},"Create Pipeline Report"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"  script:\n    - weave-validator --path <path to resources> --policies-path <path to policies> --git-repo-token $TOKEN -generate-git-report\n")),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"usecase-circleci"},"UseCase: CircleCI"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"jobs:\n  weave:\n    docker:\n    - image: weaveworks/weave-iac-validator:v1.1\n    steps:\n    - checkout\n    - run:\n        command: weave-validator --path <path to resources> --policies-path <path to policies>\n")),(0,n.kt)("h4",{id:"enable-auto-remediation-2"},"Enable Auto Remediation"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"    - run:\n        command: weave-validator --path <path to resources> --policies-path <path to policies> --git-repo-token ${GITHUB_TOKEN} --remediate\n")),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"usecase-azure-devops"},"UseCase: Azure DevOps"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"trigger:\n- <list of branches to trigger the pipeline on>\n\npool:\n  vmImage: ubuntu-latest\n\ncontainer:\n  image: weaveworks/weave-iac-validator:v1.1-azure\n\nsteps:\n- script: weave-validator --path <path to resources> --policies-path <path to policies> --git-repo-token $(TOKEN)\n")),(0,n.kt)("h4",{id:"enable-auto-remediation-3"},"Enable Auto Remediation"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"steps:\n- script: weave-validator --path <path to resources> --policies-path <path to policies> --git-repo-token $(TOKEN) --remediate\n")))}m.isMDXComponent=!0},3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>v});var r=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),u=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=u(a),d=n,v=p["".concat(s,".").concat(d)]||p[d]||m[d]||i;return a?r.createElement(v,l(l({ref:t},c),{},{components:a})):r.createElement(v,l({ref:t},c))}));function v(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,l=new Array(i);l[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[p]="string"==typeof e?e:n,l[1]=o;for(var u=2;u<i;u++)l[u]=a[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,a)}d.displayName="MDXCreateElement"}}]);