"use strict";(self.webpackChunkweave_gitops_docs=self.webpackChunkweave_gitops_docs||[]).push([[61374],{37536:(e,t,r)=>{r.d(t,{Z:()=>i});var n=r(67294),a=r(88746);r(52426);const s={fontSize:16,marginLeft:4,fontVariant:"all-small-caps"};function i(e){let{tiers:t}=e;return n.createElement(a.Z,{title:`This feature is a available on ${t}.`,style:s},t)}},85075:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var n=r(87462),a=(r(67294),r(3905)),s=r(37536);const i={title:"Join a Cluster with Azure Flux",hide_title:!0},o='Joining a Cluster with Azure Flux<TierLabel tiers="Enterprise" />',l={unversionedId:"enterprise/getting-started/join-cluster-azure-flux",id:"version-0.32.0/enterprise/getting-started/join-cluster-azure-flux",title:"Join a Cluster with Azure Flux",description:"Prerequisites",source:"@site/versioned_docs/version-0.32.0/enterprise/getting-started/join-cluster-azure-flux.mdx",sourceDirName:"enterprise/getting-started",slug:"/enterprise/getting-started/join-cluster-azure-flux",permalink:"/docs/0.32.0/enterprise/getting-started/join-cluster-azure-flux",draft:!1,editUrl:"https://github.com/weaveworks/weave-gitops/edit/main/website/versioned_docs/version-0.32.0/enterprise/getting-started/join-cluster-azure-flux.mdx",tags:[],version:"0.32.0",frontMatter:{title:"Join a Cluster with Azure Flux",hide_title:!0},sidebar:"docs",previous:{title:"Azure and Weave GitOps Enterprise Installation",permalink:"/docs/0.32.0/enterprise/getting-started/install-enterprise-azure"},next:{title:"Cluster Management - Introduction",permalink:"/docs/0.32.0/cluster-management/cluster-management-intro"}},u={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Initial Status",id:"initial-status",level:2},{value:"Joining a Cluster to WGE",id:"joining-a-cluster-to-wge",level:2},{value:"Setting up a Service Account",id:"setting-up-a-service-account",level:3},{value:"Using WGE to Deploy Clusters",id:"using-wge-to-deploy-clusters",level:2},{value:"With Cluster API",id:"with-cluster-api",level:3},{value:"With Terraform Provider",id:"with-terraform-provider",level:3},{value:"With Crossplane",id:"with-crossplane",level:3}],p={toc:c};function d(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"joining-a-cluster-with-azure-flux"},"Joining a Cluster with Azure Flux",(0,a.kt)(s.Z,{tiers:"Enterprise",mdxType:"TierLabel"})),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("p",null,"See also our ",(0,a.kt)("a",{parentName:"p",href:"/docs/0.32.0/enterprise/getting-started/install-enterprise-azure"},"guide to installing Weave GitOps Enterprise on Azure"),":"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"An Azure cluster deployed with either the Azure Portal or Azure CLI tools."),(0,a.kt)("li",{parentName:"ul"},"Azure Flux add-on deployed by adding a GitOps configuration, either via the Azure Portal or the CLI tool.")),(0,a.kt)("p",null,"Note that this documentation applies to both Azure AKS and Azure ARC clusters."),(0,a.kt)("h2",{id:"initial-status"},"Initial Status"),(0,a.kt)("p",null,"The Azure cluster already has the Azure Flux add-on installed. This differs from ",(0,a.kt)("a",{parentName:"p",href:"https://fluxcd.io/"},"CNCF Flux")," in that there are two additional controllers:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"fluxconfig-agent"),(0,a.kt)("li",{parentName:"ul"},"fluxconfig-controller")),(0,a.kt)("p",null,"These controllers have CRDs that define the version of Flux and any Flux Kustomizations that are managed via the ",(0,a.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli"},"Azure CLI"),"."),(0,a.kt)("p",null,"The CRDs are all apiVersion: clusterconfig.azure.com/v1beta1. "),(0,a.kt)("p",null,"The Kinds are:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"FluxConfig"),(0,a.kt)("li",{parentName:"ul"},"FluxConfigSyncStatus")),(0,a.kt)("p",null,"The FluxConfig Kind configures Flux itself and creates any Kustomizations that refer to a single-source GitRepository. This guide assumes that this process is already completed and that a top-level Kustomization has been configured for the fleet repo cluster directory already set up at\n",(0,a.kt)("inlineCode",{parentName:"p"},"clusters/default/CLUSTER_NAME/manifests"),"."),(0,a.kt)("p",null,"The CRDs that this FluxConfig generates are Flux CRDs, as follows:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"GitRepositories"),(0,a.kt)("li",{parentName:"ul"},"Kustomizations")),(0,a.kt)("p",null,"These generated resources are viewable through Weave GitOps Enterprise."),(0,a.kt)("p",null,"Weave GitOps itself is deployed by Flux using a HelmRelease that pulls the Helm Chart. It doesn\u2019t need to install Flux, as it is assumed that Flux is already deployed. Therefore it can use the Azure Flux add-on, which poses no conflicts with WGE itself."),(0,a.kt)("p",null,"Incompatibilities exist between the Azure Flux add-on and CNCF Flux. They should not be run at the same time, on the same cluster, due to conflicts in the CRD management. If the Flux bootstrapping process IS run on a cluster with Azure Flux add-on, it will override the Azure Flux add-on with the Flux version used in the bootstrap. Also, it would add Flux manifests to the source Git repository. This would be undesirable."),(0,a.kt)("p",null,"Azure Flux add-on-enabled clusters keep the Azure Flux add-on in place."),(0,a.kt)("h2",{id:"joining-a-cluster-to-wge"},"Joining a Cluster to WGE"),(0,a.kt)("h3",{id:"setting-up-a-service-account"},"Setting up a Service Account"),(0,a.kt)("p",null,"To join a cluster, you'll set up a service account with permissions and create a kubeconfig for the service account. This service account does not need cluster admin permissions unless you are bootstrapping Flux into the cluster. The bootstrapping process will either be A) carried out before joining the cluster to WGE; or B) configured specifically for Flux to be bootstrapped into the cluster from WGE."),(0,a.kt)("p",null,"If you already have Flux running, you can create the service account in your fleet repo:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Create a service account file:")),(0,a.kt)("details",null,(0,a.kt)("summary",null,"Expand to see role manifests"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: wgesa\n  namespace: default\n---\napiVersion: v1\nkind: Secret\ntype: kubernetes.io/service-account-token\nmetadata:\n  name: wgesa-secret\n  namespace: default\n  annotations:\n    kubernetes.io/service-account.name: "wgesa"\n'))),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"Create a roles file:")),(0,a.kt)("details",null,(0,a.kt)("summary",null,"Expand to see role manifests"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n    name: impersonate-user-groups\nsubjects:\n    - kind: ServiceAccount\n      name: wgesa\n      namespace: default\nroleRef:\n    kind: ClusterRole\n    name: user-groups-impersonator\n    apiGroup: rbac.authorization.k8s.io\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n    name: user-groups-impersonator\nrules:\n    - apiGroups: [""]\n      resources: ["users", "groups"]\n      verbs: ["impersonate"]\n    - apiGroups: [""]\n      resources: ["namespaces"]\n      verbs: ["get", "list"]\n'))),(0,a.kt)("ol",{start:3},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Commit to your fleet repo to sync.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a secret to store the kubeconfig, and a GitopsCluster object in the WGE management cluster that points to the kubeconfig secret. This allows you to connect to the target cluster and read various Kubernetes objects\u2014including the Flux objects, such as:"))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"GitRepositories"),(0,a.kt)("li",{parentName:"ul"},"HelmReleases"),(0,a.kt)("li",{parentName:"ul"},"Kustomizations"),(0,a.kt)("li",{parentName:"ul"},"Providers"),(0,a.kt)("li",{parentName:"ul"},"Alerts"),(0,a.kt)("li",{parentName:"ul"},"Receivers")),(0,a.kt)("p",null,"Kubernetes 1.24+ ",(0,a.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/75692230/secret-for-a-kubernetes-service-accounts-is-not-getting-created"},"will not create secrets for Service Accounts for you"),", so you have to add it yourself."),(0,a.kt)("ol",{start:5},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Add a new secret for the service account by adding to the service account yaml file in step 1.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a kubeconfig secret. We'll use a helper script to generate the kubeconfig, and then save it into ",(0,a.kt)("inlineCode",{parentName:"p"},"static-kubeconfig.sh"),":"),(0,a.kt)("details",null,(0,a.kt)("summary",null,"Expand to see script"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="static-kubeconfig.sh"',title:'"static-kubeconfig.sh"'},'#!/bin/bash\n\nif [[ -z "$CLUSTER_NAME" ]]; then\n        echo "Ensure CLUSTER_NAME has been set"\n        exit 1\nfi\n\nif [[ -z "$CA_CERTIFICATE" ]]; then\n        echo "Ensure CA_CERTIFICATE has been set to the path of the CA certificate"\n        exit 1\nfi\n\nif [[ -z "$ENDPOINT" ]]; then\n        echo "Ensure ENDPOINT has been set"\n        exit 1\nfi\n\nif [[ -z "$TOKEN" ]]; then\n        echo "Ensure TOKEN has been set"\n        exit 1\nfi\n\nexport CLUSTER_CA_CERTIFICATE=$(cat "$CA_CERTIFICATE" | base64)\n\nenvsubst <<EOF\napiVersion: v1\nkind: Config\nclusters:\n- name: $CLUSTER_NAME\n    cluster:\n        server: https://$ENDPOINT\n        certificate-authority-data: $CLUSTER_CA_CERTIFICATE\nusers:\n- name: $CLUSTER_NAME\n    user:\n        token: $TOKEN\ncontexts:\n- name: $CLUSTER_NAME\n    context:\n        cluster: $CLUSTER_NAME\n        user: $CLUSTER_NAME\ncurrent-context: $CLUSTER_NAME\n\nEOF\n')))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a secret for the generated kubeconfig in the WGE management cluster:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create secret generic demo-01-kubeconfig \\\n--from-file=value=./demo-01-kubeconfig\n")))),(0,a.kt)("p",null,"You can also take care of this step in WGE's ",(0,a.kt)("a",{parentName:"p",href:"https://docs.gitops.weave.works/docs/next/secrets/intro/"},"Secrets UI"),", setting up a a secret in ",(0,a.kt)("a",{parentName:"p",href:"https://docs.gitops.weave.works/docs/next/secrets/setup-sops/"},"SOPS")," or ",(0,a.kt)("a",{parentName:"p",href:"https://docs.gitops.weave.works/docs/next/secrets/setup-eso/"},"ESO"),"."),(0,a.kt)("p",null,"Flux CRDs are compatible with the Azure Flux Configuration CRDs. This means that there are no compatibility issues between WGE and Azure Flux."),(0,a.kt)("ol",{start:8},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a GitopsCluster object. It must NOT be bootstrapped. Remove the annotation for bootstrap so it will not deploy Flux.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Commit to your fleet repo and sync.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Log in to your WGE management cluster to see if the cluster has appeared."))),(0,a.kt)("h2",{id:"using-wge-to-deploy-clusters"},"Using WGE to Deploy Clusters"),(0,a.kt)("h3",{id:"with-cluster-api"},"With Cluster API"),(0,a.kt)("p",null,"MSFT maintains CAPZ, the Azure CAPI provider. Currently there is no support for Azure Flux. A CAPI-based cluster will continue to run the Flux bootstrap process on cluster creation when managed by WGE, because there is no Azure Flux option."),(0,a.kt)("h3",{id:"with-terraform-provider"},"With Terraform Provider"),(0,a.kt)("p",null,"WGE uses ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/weaveworks/tf-controller"},"TF-controller")," to deploy Terraform resources. For WGE to use the cluster as a target requires A) a resource created in the management cluster and B) a kubeconfig that maps to a service account in the target cluster. The Terraform cluster build typically creates this service account and then outputs to a secret store or local secret so that WGE can use it as a cluster. The Flux bootstrap process can be initiated directly with the Flux Terraform module, which deploys CNCF Flux to the target cluster."),(0,a.kt)("p",null,"Alternatively, you can apply an Azure Policy to provide the Azure Flux add-on. This is an example of how you can use the policy controls. This means you could come across clusters that are deployed with Terraform with the Azure Flux add-on already installed and would not run the Flux bootstrap process."),(0,a.kt)("p",null,"Either way, it is typical that Terraform-deployed clusters do not run the Flux bootstrap process at all, because it is usually already installed."),(0,a.kt)("h3",{id:"with-crossplane"},"With Crossplane"),(0,a.kt)("p",null,"The Azure Flux add-on is supported under ",(0,a.kt)("a",{parentName:"p",href:"https://www.crossplane.io/"},"Crossplane"),"-deployed Azure clusters. Any clusters deployed with Crossplane that have the Azure Flux add-on enabled would also be added to WGE without running the bootstrap process."))}d.isMDXComponent=!0},3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>m});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),u=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=u(r),h=a,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||s;return r?n.createElement(m,i(i({ref:t},c),{},{components:r})):n.createElement(m,i({ref:t},c))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=r.length,i=new Array(s);i[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[p]="string"==typeof e?e:a,i[1]=o;for(var u=2;u<s;u++)i[u]=r[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"}}]);