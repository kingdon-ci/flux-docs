"use strict";(self.webpackChunkweave_gitops_docs=self.webpackChunkweave_gitops_docs||[]).push([[94953],{74526:(e,t,a)=>{a.d(t,{Z:()=>i});var n=a(67294),l=a(88746);a(52426);const r={fontSize:16,marginLeft:4,fontVariant:"all-small-caps"};function i(e){let{tiers:t}=e;return n.createElement(l.Z,{title:`This feature is a available on ${t}.`,style:r},t)}},68917:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>c,frontMatter:()=>o,metadata:()=>m,toc:()=>u});var n=a(87462),l=(a(67294),a(3905)),r=a(74526),i=a(77823),p=a(98911);const o={title:"Using templates",hide_title:!0},s='Why GitOps templates <TierLabel tiers="Enterprise" />',m={unversionedId:"gitops-templates/templates",id:"version-0.18.0/gitops-templates/templates",title:"Using templates",description:"GitOpsTemplates enables Application Developers to self-service components and services using Weave GitOps.",source:"@site/versioned_docs/version-0.18.0/gitops-templates/templates.mdx",sourceDirName:"gitops-templates",slug:"/gitops-templates/templates",permalink:"/docs/0.18.0/gitops-templates/templates",draft:!1,editUrl:"https://github.com/weaveworks/weave-gitops/edit/main/website/versioned_docs/version-0.18.0/gitops-templates/templates.mdx",tags:[],version:"0.18.0",frontMatter:{title:"Using templates",hide_title:!0},sidebar:"docs",previous:{title:"Commit/Build Time Checks",permalink:"/docs/0.18.0/policy/commit-time-checks"},next:{title:"Quickstart templates",permalink:"/docs/0.18.0/gitops-templates/quickstart-templates"}},d={},u=[{value:"What are GitOps templates?",id:"what-are-gitops-templates",level:2},{value:"Organizing Templates",id:"organizing-templates",level:2},{value:"Enabling/Disabling Template Components",id:"enablingdisabling-template-components",level:2},{value:"Default profile values",id:"default-profile-values",level:2},{value:"Available keys",id:"available-keys",level:3},{value:"Declaring profiles with annotations",id:"declaring-profiles-with-annotations",level:3},{value:"Template paths",id:"template-paths",level:2},{value:"Specifying paths",id:"specifying-paths",level:3},{value:"Default paths",id:"default-paths",level:3},{value:"Rendering Templates",id:"rendering-templates",level:2},{value:"Editing templates",id:"editing-templates",level:3},{value:"Custom delimiters for <code>renderType: templating</code>",id:"custom-delimiters-for-rendertype-templating",level:2},{value:"Modifying the rendered resources",id:"modifying-the-rendered-resources",level:2},{value:"The <code>add-common-bases</code> annotation",id:"the-add-common-bases-annotation",level:3},{value:"The <code>inject-prune-annotation</code> annotation",id:"the-inject-prune-annotation-annotation",level:3},{value:"Differences between <code>CAPITemplate</code> and <code>GitOpsTemplate</code>",id:"differences-between-capitemplate-and-gitopstemplate",level:2},{value:"How to: Add a GitOps Template to create a cluster",id:"how-to-add-a-gitops-template-to-create-a-cluster",level:2},{value:"Parameters",id:"parameters",level:2},{value:"Required parameters",id:"required-parameters",level:3},{value:"Parameters metadata - <code>spec.params</code>",id:"parameters-metadata---specparams",level:3},{value:"Loading the template into the cluster",id:"loading-the-template-into-the-cluster",level:3},{value:"Full CAPD docker template example",id:"full-capd-docker-template-example",level:2},{value:"Versions",id:"versions",level:2},{value:"Migration notes",id:"migration-notes",level:3},{value:"<code>v1alpha1</code> to <code>v1alpha2</code>",id:"v1alpha1-to-v1alpha2",level:4},{value:"Webhooks",id:"webhooks",level:3},{value:"v1alpha1 to v1alpha2 conversion",id:"v1alpha1-to-v1alpha2-conversion",level:4},{value:"<code>v1alpha2</code> (default) notes",id:"v1alpha2-default-notes",level:3},{value:"<code>v1alpha1</code> notes",id:"v1alpha1-notes",level:3}],k={toc:u};function c(e){let{components:t,...a}=e;return(0,l.kt)("wrapper",(0,n.Z)({},k,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"why-gitops-templates-"},"Why GitOps templates ",(0,l.kt)(r.Z,{tiers:"Enterprise",mdxType:"TierLabel"})),(0,l.kt)("p",null,"GitOpsTemplates enables Application Developers to self-service components and services using Weave GitOps.\nTurning knowledge into a library that can be self-served."),(0,l.kt)("h2",{id:"what-are-gitops-templates"},"What are GitOps templates?"),(0,l.kt)("p",null,"GitOps templates allows you to template resources in a single definition. Resources in a template can be anything that can be expressed in yaml (K8s, Flux primitives, TF controller, Crossplane, Cluster API). "),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"FAQ")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"What are GitOps templates?"),"\nGitOps templates allow you to template resources in a single definition. Resources in a template can be anything that can be expressed in yaml (K8s, Flux primitives, TF controller, Crossplane, Cluster API).\nTemplates are simple YAML files, that can be enriched with Parameters, Variables, Metadata and conditions. They can be rendered to create the resources they contain. For clusters it can be CAPI objects like MachinePool. It can be as well Kustomization (flux) or a TF controller resource. "),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Ok, what are the restrictions on GitOps templates?")),(0,l.kt)("p",null,"Basically, the only restriction is that the template needs to be valid YAML. Besides that a rendered template can create any kind of resource. "),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"How do they fit today into Weave GitOps?")),(0,l.kt)("p",null,"We have added some metadata markup, which helps us to render the template nicely in the GUI. "),(0,l.kt)("p",null,"The template consumer will be only provided with the required Parameters/Inputs and the guardrails, the template gets rendered and we create a PR. Merging the PR will create all the templated resources."),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"How can I use GitOps templates?")),(0,l.kt)("p",null,"GitOps Templates were originally introduced enabling self-service in the cluster creation flow.  We quickly extended that to terraform, crossplane and Kubernetes resources like RBAC (Roles + Rolebindings).\nYou can have for example a template that provides a running Developer Environment, consisting in a EKS cluster, a RDS Database, and a branch + revision of the current application through a single template. "),(0,l.kt)("h2",{id:"organizing-templates"},"Organizing Templates"),(0,l.kt)("p",null,"Declare the type of a template by using the ",(0,l.kt)("inlineCode",{parentName:"p"},"weave.works/template-type")," label. The value of the label is the name of the template type. The template type is used to group templates in the UI."),(0,l.kt)("p",null,"Recommended template types:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"application")," - for application templates"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"cluster")," - for cluster templates"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"terraform")," - for Terraform templates"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"pipeline")," - for Pipeline templates")),(0,l.kt)("h2",{id:"enablingdisabling-template-components"},"Enabling/Disabling Template Components"),(0,l.kt)("p",null,"Enable or disable rendering of certain component sections in a template with the use of annotations. This can be done by using the ",(0,l.kt)("inlineCode",{parentName:"p"},"templates.weave.works/COMPONENT-enabled")," annotation with a boolean value."),(0,l.kt)("p",null,"Supported components:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"profiles")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"kustomizations")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"credentials"))),(0,l.kt)("p",null,"Example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'annotations:\n  templates.weave.works/profiles-enabled: "true"\n  templates.weave.works/kustomizations-enabled: "true"\n  templates.weave.works/credentials-enabled: "true"\n')),(0,l.kt)("h2",{id:"default-profile-values"},"Default profile values"),(0,l.kt)("p",null,"Default and required profiles can be added via the template ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.charts")," section."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  charts:\n    items:\n      - name: nginx\n        version: 1.0.0\n        targetNamespace: nginx\n      - name: cert-manager\n        targetNamespace: cert-manager\n")),(0,l.kt)("h3",{id:"available-keys"},"Available keys"),(0,l.kt)("p",null,"Keys available in the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.charts.items")," entries and the template variables available to them."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Key")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Description")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Template vars")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"template.content")),(0,l.kt)("td",{parentName:"tr",align:null},"Full or partial ",(0,l.kt)("inlineCode",{parentName:"td"},"HelmRelease")," CR template"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"params"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"chart")),(0,l.kt)("td",{parentName:"tr",align:null},"Shortcut to ",(0,l.kt)("inlineCode",{parentName:"td"},"HelmRelease.spec.chart.spec.chart")),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"version")),(0,l.kt)("td",{parentName:"tr",align:null},"Shortcut to ",(0,l.kt)("inlineCode",{parentName:"td"},"HelmRelease.spec.chart.spec.version")),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"targetNamespace")),(0,l.kt)("td",{parentName:"tr",align:null},"Shortcut to ",(0,l.kt)("inlineCode",{parentName:"td"},"HelmRelease.spec.targetNamespace")),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"values")),(0,l.kt)("td",{parentName:"tr",align:null},"Shortcut to ",(0,l.kt)("inlineCode",{parentName:"td"},"HelmRelease.spec.values")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"params"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"layer")),(0,l.kt)("td",{parentName:"tr",align:null},"Layer to install as"),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"required")),(0,l.kt)("td",{parentName:"tr",align:null},"(default=false) Allow the user to de-select this profile"),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"editable")),(0,l.kt)("td",{parentName:"tr",align:null},"(default=false) Allow the user to edit the values.yaml of this profile"),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("p",null,"Here is a more complete example showing all the available keys and the sections that can be templated."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  charts:\n    items:\n      - chart: cert-manager\n        version: v1.5.3\n        editable: false\n        required: true\n        values:\n          installCRDs: ${CERT_MANAGER_INSTALL_CRDS}\n        targetNamespace: cert-manager\n        layer: layer-1\n        template:\n          content:\n            metadata:\n              labels:\n                app.kubernetes.io/name: cert-manager\n            spec:\n              retries: ${CERT_MANAGER_RETRY_COUNT}\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"template.content")," will be merged over the top of a default ",(0,l.kt)("inlineCode",{parentName:"p"},"HelmRelease")," CR so it does not need to be complete."),(0,l.kt)("h3",{id:"declaring-profiles-with-annotations"},"Declaring profiles with annotations"),(0,l.kt)("admonition",{title:"Deprecated feature",type:"caution"},(0,l.kt)("p",{parentName:"admonition"},"Where possible please use the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.charts")," section to declare profiles.")),(0,l.kt)("p",null,"You can also use the ",(0,l.kt)("inlineCode",{parentName:"p"},"capi.weave.works/profile-INDEX")," annotation to specify profiles."),(0,l.kt)("p",null,"The annotation is added as the following:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'annotations:\n    capi.weave.works/profile-0: \'{"name": "NAME", "version": "VERSION", "editable": EDITABLE, "namespace": "NAMESPACE"}\'\n')),(0,l.kt)("p",null,"Where"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"name")," -  is the name of the profile in the default profiles repository"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"version")," -  (optional) will choose the default version"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"namespace")," -  (optional) is the default target namespace for the profile"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"editable")," -  (optional, default=false), allow the user to de-select this profile, making it a default instead of a requirement.")),(0,l.kt)("h2",{id:"template-paths"},"Template paths"),(0,l.kt)("h3",{id:"specifying-paths"},"Specifying paths"),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates[].path")," field can be used to specify the paths of the rendered template resources.\nThis allows more control over where different resources in the template are rendered."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"The path is relative to the repository root."),(0,l.kt)("li",{parentName:"ul"},"The path can be templated using params")),(0,l.kt)("p",null,"Example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  resourcetemplates:\n    // highlight-next-line\n    - path: clusters/${CLUSTER_NAME}/definition/cluster.yaml\n      content:\n        - apiVersion: cluster.x-k8s.io/v1alpha4\n          kind: Cluster\n          metadata:\n            name: ${CLUSTER_NAME}\n          ...\n        - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4\n          kind: AWSCluster\n          metadata:\n            name: ${CLUSTER_NAME}\n          ...\n    // highlight-next-line\n    - path: clusters/${CLUSTER_NAME}/workloads/helmreleases.yaml\n      content:\n        - apiVersion: helm.toolkit.fluxcd.io/v2beta1\n          kind: HelmRelease\n          metadata:\n            name: ${CLUSTER_NAME}-nginx\n          ...\n        - apiVersion: helm.toolkit.fluxcd.io/v2beta1\n          kind: HelmRelease\n          metadata:\n            name: ${CLUSTER_NAME}-cert-manager\n          ...\n")),(0,l.kt)("h3",{id:"default-paths"},"Default paths"),(0,l.kt)("p",null,"If the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates[].path")," is omitted a default path for the rendered template is calculated.\nIn this case some some of the submitted params are used. You must provide one of the following parameters:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"CLUSTER_NAME")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"RESOURCE_NAME"))),(0,l.kt)("admonition",{type:"info"},(0,l.kt)("p",{parentName:"admonition"},"The ",(0,l.kt)("strong",{parentName:"p"},"profiles")," and ",(0,l.kt)("strong",{parentName:"p"},"kustomization")," features always use a calculated default path.\n",(0,l.kt)("strong",{parentName:"p"},"If you are using these features")," one of ",(0,l.kt)("inlineCode",{parentName:"p"},"CLUSTER_NAME")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"RESOURCE_NAME")," must be provided,\neven if you specify a ",(0,l.kt)("inlineCode",{parentName:"p"},"path")," for all the other resources in the template.")),(0,l.kt)("p",null,"The default path for a template has a few components:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"From the params: ",(0,l.kt)("inlineCode",{parentName:"li"},"CLUSTER_NAME")," or ",(0,l.kt)("inlineCode",{parentName:"li"},"RESOURCE_NAME"),", ",(0,l.kt)("strong",{parentName:"li"},"required"),"."),(0,l.kt)("li",{parentName:"ul"},"From the params: ",(0,l.kt)("inlineCode",{parentName:"li"},"NAMESPACE"),", default: ",(0,l.kt)("inlineCode",{parentName:"li"},"default")),(0,l.kt)("li",{parentName:"ul"},"From values.yaml for the Weave GitOps Enterprise ",(0,l.kt)("inlineCode",{parentName:"li"},"mccp")," chart: ",(0,l.kt)("inlineCode",{parentName:"li"},"values.config.capi.repositoryPath"),", default: ",(0,l.kt)("inlineCode",{parentName:"li"},"clusters/management/clusters"))),(0,l.kt)("p",null,"These are composed to create the path:\n",(0,l.kt)("inlineCode",{parentName:"p"},"${repositoryPath}/${NAMESPACE}/${CLUSTER_OR_RESOURCE_NAME}.yaml")),(0,l.kt)("p",null,"Using the default values and supplying ",(0,l.kt)("inlineCode",{parentName:"p"},"CLUSTER_NAME")," as ",(0,l.kt)("inlineCode",{parentName:"p"},"my-cluster")," will result in the path:\n",(0,l.kt)("inlineCode",{parentName:"p"},"clusters/management/clusters/default/my-cluster.yaml")),(0,l.kt)("h2",{id:"rendering-templates"},"Rendering Templates"),(0,l.kt)("p",null,"Declare the render type indicating the templating language to be used to render the template by setting ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.renderType"),"."),(0,l.kt)("p",null,"Supported templating languages:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("strong",{parentName:"p"},"envsubst (default)"),"\nenvsubst which is short for environment substitution uses ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/a8m/envsubst"},"envsubst")," for rendering, where ",(0,l.kt)("inlineCode",{parentName:"p"},"${CLUSTER_NAME}")," style syntax can be used. It is the same templating format that is used by ",(0,l.kt)("a",{parentName:"p",href:"https://cluster-api.sigs.k8s.io/clusterctl/overview.html"},"clusterctl"),"."),(0,l.kt)("h4",{parentName:"li",id:"supported-functions"},"Supported Functions"),(0,l.kt)("table",{parentName:"li"},(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Expression")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Meaning")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var}")),(0,l.kt)("td",{parentName:"tr",align:null},"Value of ",(0,l.kt)("inlineCode",{parentName:"td"},"$var"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${#var}")),(0,l.kt)("td",{parentName:"tr",align:null},"String length of ",(0,l.kt)("inlineCode",{parentName:"td"},"$var"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var^}")),(0,l.kt)("td",{parentName:"tr",align:null},"Uppercase first character of ",(0,l.kt)("inlineCode",{parentName:"td"},"$var"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var^^}")),(0,l.kt)("td",{parentName:"tr",align:null},"Uppercase all characters in ",(0,l.kt)("inlineCode",{parentName:"td"},"$var"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var,}")),(0,l.kt)("td",{parentName:"tr",align:null},"Lowercase first character of ",(0,l.kt)("inlineCode",{parentName:"td"},"$var"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var,,}")),(0,l.kt)("td",{parentName:"tr",align:null},"Lowercase all characters in ",(0,l.kt)("inlineCode",{parentName:"td"},"$var"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var:n}")),(0,l.kt)("td",{parentName:"tr",align:null},"Offset ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," ",(0,l.kt)("inlineCode",{parentName:"td"},"n")," characters from start")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var:n:len}")),(0,l.kt)("td",{parentName:"tr",align:null},"Offset ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," ",(0,l.kt)("inlineCode",{parentName:"td"},"n")," characters with max length of ",(0,l.kt)("inlineCode",{parentName:"td"},"len"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var#pattern}")),(0,l.kt)("td",{parentName:"tr",align:null},"Strip shortest ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," match from start")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var##pattern}")),(0,l.kt)("td",{parentName:"tr",align:null},"Strip longest ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," match from start")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var%pattern}")),(0,l.kt)("td",{parentName:"tr",align:null},"Strip shortest ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," match from end")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var%%pattern}")),(0,l.kt)("td",{parentName:"tr",align:null},"Strip longest ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," match from end")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var-default}")),(0,l.kt)("td",{parentName:"tr",align:null},"If ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," is not set, evaluate expression as ",(0,l.kt)("inlineCode",{parentName:"td"},"$default"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var:-default}")),(0,l.kt)("td",{parentName:"tr",align:null},"If ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," is not set or is empty, evaluate expression as ",(0,l.kt)("inlineCode",{parentName:"td"},"$default"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var=default}")),(0,l.kt)("td",{parentName:"tr",align:null},"If ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," is not set, evaluate expression as ",(0,l.kt)("inlineCode",{parentName:"td"},"$default"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var:=default}")),(0,l.kt)("td",{parentName:"tr",align:null},"If ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," is not set or is empty, evaluate expression as ",(0,l.kt)("inlineCode",{parentName:"td"},"$default"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var/pattern/replacement}")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace as few ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," matches as possible with ",(0,l.kt)("inlineCode",{parentName:"td"},"replacement"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var//pattern/replacement}")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace as many ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," matches as possible with ",(0,l.kt)("inlineCode",{parentName:"td"},"replacement"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var/#pattern/replacement}")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," match with ",(0,l.kt)("inlineCode",{parentName:"td"},"replacement")," from ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," start")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"${var/%pattern/replacement}")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace ",(0,l.kt)("inlineCode",{parentName:"td"},"pattern")," match with ",(0,l.kt)("inlineCode",{parentName:"td"},"replacement")," from ",(0,l.kt)("inlineCode",{parentName:"td"},"$var")," end"))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("strong",{parentName:"p"},"templating")),(0,l.kt)("p",{parentName:"li"},"templating uses text/templating for rendering, using go-templating style syntax ",(0,l.kt)("inlineCode",{parentName:"p"},"{{ .params.CLUSTER_NAME }}")," where params are provided by the ",(0,l.kt)("inlineCode",{parentName:"p"},".params")," variable.\nTemplate functions can also be used with the syntax ",(0,l.kt)("inlineCode",{parentName:"p"},"{{ .params.CLUSTER_NAME | FUNCTION }}"),". "),(0,l.kt)("h4",{parentName:"li",id:"supported-functions-from-sprig-library"},"Supported functions ",(0,l.kt)("a",{parentName:"h4",href:"http://masterminds.github.io/sprig/"},"(from Sprig library)")),(0,l.kt)("table",{parentName:"li"},(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Function Type")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Functions")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"String Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"trim"),", ",(0,l.kt)("em",{parentName:"td"},"wrap"),", ",(0,l.kt)("em",{parentName:"td"},"randAlpha"),", ",(0,l.kt)("em",{parentName:"td"},"plural"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"String List Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"splitList"),", ",(0,l.kt)("em",{parentName:"td"},"sortAlpha"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Integer Math Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"add"),", ",(0,l.kt)("em",{parentName:"td"},"max"),", ",(0,l.kt)("em",{parentName:"td"},"mul"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Integer Slice Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"until"),", untilStep")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Float Math Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"addf"),", ",(0,l.kt)("em",{parentName:"td"},"maxf"),", ",(0,l.kt)("em",{parentName:"td"},"mulf"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Date Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"now"),", ",(0,l.kt)("em",{parentName:"td"},"date"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Defaults Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"default"),", ",(0,l.kt)("em",{parentName:"td"},"empty"),", ",(0,l.kt)("em",{parentName:"td"},"coalesce"),", ",(0,l.kt)("em",{parentName:"td"},"fromJson"),", ",(0,l.kt)("em",{parentName:"td"},"toJson"),", ",(0,l.kt)("em",{parentName:"td"},"toPrettyJson"),", ",(0,l.kt)("em",{parentName:"td"},"toRawJson"),", ternary")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Encoding Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"b64enc"),", ",(0,l.kt)("em",{parentName:"td"},"b64dec"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Lists and List Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"list"),", ",(0,l.kt)("em",{parentName:"td"},"first"),", ",(0,l.kt)("em",{parentName:"td"},"uniq"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Dictionaries and Dict Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"get"),", ",(0,l.kt)("em",{parentName:"td"},"set"),", ",(0,l.kt)("em",{parentName:"td"},"dict"),", ",(0,l.kt)("em",{parentName:"td"},"hasKey"),", ",(0,l.kt)("em",{parentName:"td"},"pluck"),", ",(0,l.kt)("em",{parentName:"td"},"dig"),", ",(0,l.kt)("em",{parentName:"td"},"deepCopy"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Type Conversion Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"atoi"),", ",(0,l.kt)("em",{parentName:"td"},"int64"),", ",(0,l.kt)("em",{parentName:"td"},"toString"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Flow Control Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"fail"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"UUID Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"uuidv4"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Version Comparison Functions"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"semver"),", semverCompare")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Reflection"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("em",{parentName:"td"},"typeOf"),", ",(0,l.kt)("em",{parentName:"td"},"kindIs"),", ",(0,l.kt)("em",{parentName:"td"},"typeIsLike"))))))),(0,l.kt)("h3",{id:"editing-templates"},"Editing templates"),(0,l.kt)("p",null,"When rendering a template, a ",(0,l.kt)("inlineCode",{parentName:"p"},"templates.weave.works/create-request")," annotation is added by default to the first resource in the ",(0,l.kt)("inlineCode",{parentName:"p"},"resourcetemplates"),". It can be added to any other resource by simply adding the annotation in empty form. This annotation  holds information about which template generated the resource and the parameter values used as a json string."),(0,l.kt)("p",null,"If the resource type is one of the following and has this annotation, an ",(0,l.kt)("inlineCode",{parentName:"p"},"Edit resource")," button will appear in the UI that allows the editing of the resource and re-rendering it:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Applications:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"HelmRelease"),(0,l.kt)("li",{parentName:"ul"},"Kustomization"))),(0,l.kt)("li",{parentName:"ul"},"Sources:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"HelmRepository"),(0,l.kt)("li",{parentName:"ul"},"GitRepository"))),(0,l.kt)("li",{parentName:"ul"},"Clusters:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"GitopsCluster")))),(0,l.kt)("p",null,"Example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  resourcetemplates:\n  - apiVersion: v1\n    kind: ConfigMap\n    metadata:\n      name: my-configmap\n    data:\n      my-key: my-value\n  - apiVersion: source.toolkit.fluxcd.io/v1beta1\n    kind: HelmRepository\n    metadata:\n      # This annotation will add an `Edit resource` button in the UI for this resource\n      annotations:\n        templates.weave.works/create-request: ''\n      name: nginx\n      namespace: default\n")),(0,l.kt)("h2",{id:"custom-delimiters-for-rendertype-templating"},"Custom delimiters for ",(0,l.kt)("inlineCode",{parentName:"h2"},"renderType: templating")),(0,l.kt)("p",null,"The default delimiters for ",(0,l.kt)("inlineCode",{parentName:"p"},"renderType: templating")," are ",(0,l.kt)("inlineCode",{parentName:"p"},"{{")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"}}"),". These can be changed by setting the ",(0,l.kt)("inlineCode",{parentName:"p"},"templates.weave.works/delimiters")," annotation on the profile. For example:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},'templates.weave.works/delimiters: "{{,}}"')," - default"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},'templates.weave.works/delimiters: "${{,}}"'),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Use ",(0,l.kt)("inlineCode",{parentName:"li"},"${{")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"}}"),", for example ",(0,l.kt)("inlineCode",{parentName:"li"},"${{ .params.CLUSTER_NAME }}")),(0,l.kt)("li",{parentName:"ul"},"Useful as ",(0,l.kt)("inlineCode",{parentName:"li"},"{{")," in yaml is invalid syntax and needs to be quoted. If you need to provide a un-quoted number value like ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas: 3")," you should use these delimiters."),(0,l.kt)("li",{parentName:"ul"},"\u274c ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas: {{ .params.REPLICAS }}")," Invalid yaml "),(0,l.kt)("li",{parentName:"ul"},"\u274c ",(0,l.kt)("inlineCode",{parentName:"li"},'replicas: "{{ .params.REPLICAS }}"')," Valid yaml, incorrect type. The type is a ",(0,l.kt)("inlineCode",{parentName:"li"},"string")," not a ",(0,l.kt)("inlineCode",{parentName:"li"},"number")," and will fail validation."),(0,l.kt)("li",{parentName:"ul"},"\u2705 ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas: ${{ .params.REPLICAS }}")," Valid yaml and correct ",(0,l.kt)("inlineCode",{parentName:"li"},"number")," type."))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},'templates.weave.works/delimiters: "<<,>>" '),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Use ",(0,l.kt)("inlineCode",{parentName:"li"},"<<")," and ",(0,l.kt)("inlineCode",{parentName:"li"},">>"),", for example ",(0,l.kt)("inlineCode",{parentName:"li"},"<< .params.CLUSTER_NAME >>")),(0,l.kt)("li",{parentName:"ul"},"Useful if you are nesting templates and need to differentiate between the delimiters used in the inner and outer templates.")))),(0,l.kt)("h2",{id:"modifying-the-rendered-resources"},"Modifying the rendered resources"),(0,l.kt)("h3",{id:"the-add-common-bases-annotation"},"The ",(0,l.kt)("inlineCode",{parentName:"h3"},"add-common-bases")," annotation"),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},'templates.weave.works/add-common-bases: "true"'),' annotation can be used to\nenabled and disable the addition of a "common bases" ',(0,l.kt)("inlineCode",{parentName:"p"},"Kustomization")," to the\nlist of rendered files.\nThis kustomization will sync a path that is common to all clusters (",(0,l.kt)("inlineCode",{parentName:"p"},"clusters/bases"),"). Useful to add RBAC and policy that should be applied to all clusters."),(0,l.kt)("h3",{id:"the-inject-prune-annotation-annotation"},"The ",(0,l.kt)("inlineCode",{parentName:"h3"},"inject-prune-annotation")," annotation"),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},'templates.weave.works/inject-prune-annotation: "true"')," annotation can be used to\nenable and disable the injection of Flux's ",(0,l.kt)("inlineCode",{parentName:"p"},"prune")," annotation into certain resources."),(0,l.kt)("p",null,"When enabled we automatically inject a ",(0,l.kt)("inlineCode",{parentName:"p"},"kustomize.toolkit.fluxcd.io/prune: disabled"),"\nannotation into every resource in the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates")," that is not a\n",(0,l.kt)("inlineCode",{parentName:"p"},"cluster.x-k8s.io.Cluster")," and not a ",(0,l.kt)("inlineCode",{parentName:"p"},"gitops.weave.works.GitopsCluster"),"."),(0,l.kt)("p",null,"The intention here is stop flux from explicitly deleting subresources of the ",(0,l.kt)("inlineCode",{parentName:"p"},"Cluster")," like\n",(0,l.kt)("inlineCode",{parentName:"p"},"AWSCluster"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"KubeadmControlPlane"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"AWSMachineTemplate")," etc and let the capi-controllers remove them itself."),(0,l.kt)("p",null,"This is the pattern recommended in the capi-quickstart guide ",(0,l.kt)("a",{parentName:"p",href:"https://cluster-api.sigs.k8s.io/user/quick-start.html#clean-up"},"https://cluster-api.sigs.k8s.io/user/quick-start.html#clean-up"),"."),(0,l.kt)("h2",{id:"differences-between-capitemplate-and-gitopstemplate"},"Differences between ",(0,l.kt)("inlineCode",{parentName:"h2"},"CAPITemplate")," and ",(0,l.kt)("inlineCode",{parentName:"h2"},"GitOpsTemplate")),(0,l.kt)("p",null,"The only difference between ",(0,l.kt)("inlineCode",{parentName:"p"},"CAPITemplate")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"GitOpsTemplate")," is the default value of these two annotations:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Annotation"),(0,l.kt)("th",{parentName:"tr",align:null},"default value for ",(0,l.kt)("inlineCode",{parentName:"th"},"CAPITemplate")),(0,l.kt)("th",{parentName:"tr",align:null},"default value for ",(0,l.kt)("inlineCode",{parentName:"th"},"GitOpsTemplate")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"templates.weave.works/add-common-bases")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'"true"')),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'"false"'))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"templates.weave.works/inject-prune-annotations")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'"true"')),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'"false"'))))),(0,l.kt)("h2",{id:"how-to-add-a-gitops-template-to-create-a-cluster"},"How to: Add a GitOps Template to create a cluster"),(0,l.kt)("p",null,"GitOps Templates objects need to be wrapped with the ",(0,l.kt)("inlineCode",{parentName:"p"},"GitOpsTemplate")," custom resource and then loaded into the management cluster."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: templates.weave.works/v1alpha2\nkind: GitOpsTemplate\nmetadata:\n  name: cluster-template-development\n  labels:\n    weave.works/template-type: cluster\nspec:\n  description: This is the std. CAPD template\n  renderType: templating\n  params:\n    - name: CLUSTER_NAME\n      description: This is used for the cluster naming.\n  resourcetemplates:\n    - apiVersion: cluster.x-k8s.io/v1alpha3\n      kind: Cluster\n      metadata:\n        name: "{{ .params.CLUSTER_NAME }}"\n')),(0,l.kt)("h2",{id:"parameters"},"Parameters"),(0,l.kt)("p",null,"You can provide additional metadata about the parameters to the templates in the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.params")," section."),(0,l.kt)("h3",{id:"required-parameters"},"Required parameters"),(0,l.kt)("p",null,"See the ",(0,l.kt)("a",{parentName:"p",href:"#template-paths"},"Template Paths")," section for info on certain required parameters that are used to determine the path of the template."),(0,l.kt)("h3",{id:"parameters-metadata---specparams"},"Parameters metadata - ",(0,l.kt)("inlineCode",{parentName:"h3"},"spec.params")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"name"),": The variable name within the resource templates"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"description"),": Description of the parameter. This will be rendered in the UI and CLI"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"options"),": The list of possible values this parameter can be set to."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"required")," -  Whether the parameter must contain a non-empty value"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"default")," - Default value of the parameter ")),(0,l.kt)("p",null,"Sample:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"spec:\n  params:\n    - name: PARAM_NAME_1\n      description: DESC_1\n      options: [OPTION_1,OPTION_2]\n      default: OPTION_1\n    - name: PARAM_NAME_2\n      description: DESC_1\n      required: true\n      default: DEFAULT_2\n")),(0,l.kt)("h3",{id:"loading-the-template-into-the-cluster"},"Loading the template into the cluster"),(0,l.kt)("p",null,"Load templates into the cluster by adding them to your flux managed git repository or by using apply directly with\n",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl apply -f capi-template.yaml")),(0,l.kt)("p",null,"Weave GitOps will search for templates in the ",(0,l.kt)("inlineCode",{parentName:"p"},"default")," namespace. This can be changed by configuring the ",(0,l.kt)("inlineCode",{parentName:"p"},"config.capi.namespace")," value in the helm chart."),(0,l.kt)("h2",{id:"full-capd-docker-template-example"},"Full CAPD docker template example"),(0,l.kt)("p",null,"This example works with the CAPD provider, see ",(0,l.kt)("a",{parentName:"p",href:"/docs/0.18.0/cluster-management/cluster-api-providers"},"Cluster API Providers"),"."),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Expand to view"),(0,l.kt)(i.Z,{title:"clusters/management/capi/templates/capd-template.yaml",className:"language-yaml",mdxType:"CodeBlock"},p.Z)),(0,l.kt)("h2",{id:"versions"},"Versions"),(0,l.kt)("p",null,"There are now multiple published versions of the template CRD."),(0,l.kt)("h3",{id:"migration-notes"},"Migration notes"),(0,l.kt)("h4",{id:"v1alpha1-to-v1alpha2"},(0,l.kt)("inlineCode",{parentName:"h4"},"v1alpha1")," to ",(0,l.kt)("inlineCode",{parentName:"h4"},"v1alpha2")),(0,l.kt)("p",null,"When manually migrating a template from v1alpha1 to v1alpha2 (for example in git) you will need to:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Update the ",(0,l.kt)("inlineCode",{parentName:"li"},"apiVersion")," to ",(0,l.kt)("inlineCode",{parentName:"li"},"templates.weave.works/v1alpha2")),(0,l.kt)("li",{parentName:"ol"},"Move the ",(0,l.kt)("inlineCode",{parentName:"li"},"spec.resourcetemplates")," field to ",(0,l.kt)("inlineCode",{parentName:"li"},"spec.resourcetemplates[0].contents")),(0,l.kt)("li",{parentName:"ol"},"Either leave the ",(0,l.kt)("inlineCode",{parentName:"li"},"spec.resourcetemplates[0].path")," field empty or give it a sensible value.")),(0,l.kt)("p",null,"If you experience issues with the path not being recognised when flux reconciles the new template versions\nyou should try manually applying the new template to the cluster directly with:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Run ",(0,l.kt)("inlineCode",{parentName:"li"},"kubectl apply -f capi-template.yaml")),(0,l.kt)("li",{parentName:"ol"},"Run ",(0,l.kt)("inlineCode",{parentName:"li"},"flux reconcile kustomization --with-source flux-system")," ",(0,l.kt)("strong",{parentName:"li"},"two times"),".")),(0,l.kt)("h3",{id:"webhooks"},"Webhooks"),(0,l.kt)("p",null,"A conversion webhook is hosted by the ",(0,l.kt)("inlineCode",{parentName:"p"},"flux-system/templates-controller-webhook-service")," service.\n",(0,l.kt)("inlineCode",{parentName:"p"},"v1alpha1")," templates are automatically converted to ",(0,l.kt)("inlineCode",{parentName:"p"},"v1alpha2")," when they are loaded into the cluster."),(0,l.kt)("h4",{id:"v1alpha1-to-v1alpha2-conversion"},"v1alpha1 to v1alpha2 conversion"),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates")," field is moved to ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates[0].contents")," and the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates[0].path")," is left empty.\nWhen the tempalte is rendered the ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates[0].path")," field has a default value calculated."),(0,l.kt)("h3",{id:"v1alpha2-default-notes"},(0,l.kt)("inlineCode",{parentName:"h3"},"v1alpha2")," (default) notes"),(0,l.kt)("p",null,"This version changes the type of ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates")," from a list of objects to a list of files with a ",(0,l.kt)("inlineCode",{parentName:"p"},"path")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"contents"),":"),(0,l.kt)("p",null,"Example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'spec:\n  resourcetemplates:\n    - path: "clusters/{{ .params.CLUSTER_NAME }}.yaml"\n      contents:\n        - apiVersion: cluster.x-k8s.io/v1alpha3\n          kind: Cluster\n          metadata:\n            name: "{{ .params.CLUSTER_NAME }}"\n          path: "clusters/{{ .params.CLUSTER_NAME }}.yaml"\n')),(0,l.kt)("h3",{id:"v1alpha1-notes"},(0,l.kt)("inlineCode",{parentName:"h3"},"v1alpha1")," notes"),(0,l.kt)("p",null,"The original version of the template. This version is deprecated and will be removed in a future release."),(0,l.kt)("p",null,"It uses ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.resourcetemplates")," as a list of resources to render."),(0,l.kt)("p",null,"Example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'spec:\n  resourcetemplates:\n    - apiVersion: cluster.x-k8s.io/v1alpha3\n      kind: Cluster\n      metadata:\n        name: "{{ .params.CLUSTER_NAME }}"\n')))}c.isMDXComponent=!0},98911:(e,t,a)=>{a.d(t,{Z:()=>n});const n='apiVersion: templates.weave.works/v1alpha2\nkind: GitOpsTemplate\nmetadata:\n  name: cluster-template-development\n  namespace: default\n  annotations:\n    templates.weave.works/add-common-bases: "true"\n    templates.weave.works/inject-prune-annotation: "true"\n  labels:\n    weave.works/template-type: cluster\nspec:\n  description: A simple CAPD template\n  params:\n    - name: CLUSTER_NAME\n      required: true\n      description: This is used for the cluster naming.\n    - name: NAMESPACE\n      description: Namespace to create the cluster in\n    - name: KUBERNETES_VERSION\n      description: Kubernetes version to use for the cluster\n      options: ["1.19.11", "1.21.1", "1.22.0", "1.23.3"]\n    - name: CONTROL_PLANE_MACHINE_COUNT\n      description: Number of control planes\n      options: ["1", "2", "3"]\n    - name: WORKER_MACHINE_COUNT\n      description: Number of worker machines\n  resourcetemplates:\n    - content:\n        - apiVersion: gitops.weave.works/v1alpha1\n          kind: GitopsCluster\n          metadata:\n            name: "${CLUSTER_NAME}"\n            namespace: "${NAMESPACE}"\n            labels:\n              weave.works/capi: bootstrap\n          spec:\n            capiClusterRef:\n              name: "${CLUSTER_NAME}"\n        - apiVersion: cluster.x-k8s.io/v1beta1\n          kind: Cluster\n          metadata:\n            name: "${CLUSTER_NAME}"\n            namespace: "${NAMESPACE}"\n            labels:\n              cni: calico\n          spec:\n            clusterNetwork:\n              pods:\n                cidrBlocks:\n                  - 192.168.0.0/16\n              serviceDomain: cluster.local\n              services:\n                cidrBlocks:\n                  - 10.128.0.0/12\n            controlPlaneRef:\n              apiVersion: controlplane.cluster.x-k8s.io/v1beta1\n              kind: KubeadmControlPlane\n              name: "${CLUSTER_NAME}-control-plane"\n              namespace: "${NAMESPACE}"\n            infrastructureRef:\n              apiVersion: infrastructure.cluster.x-k8s.io/v1beta1\n              kind: DockerCluster\n              name: "${CLUSTER_NAME}"\n              namespace: "${NAMESPACE}"\n        - apiVersion: infrastructure.cluster.x-k8s.io/v1beta1\n          kind: DockerCluster\n          metadata:\n            name: "${CLUSTER_NAME}"\n            namespace: "${NAMESPACE}"\n        - apiVersion: infrastructure.cluster.x-k8s.io/v1beta1\n          kind: DockerMachineTemplate\n          metadata:\n            name: "${CLUSTER_NAME}-control-plane"\n            namespace: "${NAMESPACE}"\n          spec:\n            template:\n              spec:\n                extraMounts:\n                  - containerPath: /var/run/docker.sock\n                    hostPath: /var/run/docker.sock\n        - apiVersion: controlplane.cluster.x-k8s.io/v1beta1\n          kind: KubeadmControlPlane\n          metadata:\n            name: "${CLUSTER_NAME}-control-plane"\n            namespace: "${NAMESPACE}"\n          spec:\n            kubeadmConfigSpec:\n              clusterConfiguration:\n                apiServer:\n                  certSANs:\n                    - localhost\n                    - 127.0.0.1\n                    - 0.0.0.0\n                controllerManager:\n                  extraArgs:\n                    enable-hostpath-provisioner: "true"\n              initConfiguration:\n                nodeRegistration:\n                  criSocket: /var/run/containerd/containerd.sock\n                  kubeletExtraArgs:\n                    cgroup-driver: cgroupfs\n                    eviction-hard: nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%\n              joinConfiguration:\n                nodeRegistration:\n                  criSocket: /var/run/containerd/containerd.sock\n                  kubeletExtraArgs:\n                    cgroup-driver: cgroupfs\n                    eviction-hard: nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%\n            machineTemplate:\n              infrastructureRef:\n                apiVersion: infrastructure.cluster.x-k8s.io/v1beta1\n                kind: DockerMachineTemplate\n                name: "${CLUSTER_NAME}-control-plane"\n                namespace: "${NAMESPACE}"\n            replicas: "${CONTROL_PLANE_MACHINE_COUNT}"\n            version: "${KUBERNETES_VERSION}"\n        - apiVersion: infrastructure.cluster.x-k8s.io/v1beta1\n          kind: DockerMachineTemplate\n          metadata:\n            name: "${CLUSTER_NAME}-md-0"\n            namespace: "${NAMESPACE}"\n          spec:\n            template:\n              spec: {}\n        - apiVersion: bootstrap.cluster.x-k8s.io/v1beta1\n          kind: KubeadmConfigTemplate\n          metadata:\n            name: "${CLUSTER_NAME}-md-0"\n            namespace: "${NAMESPACE}"\n          spec:\n            template:\n              spec:\n                joinConfiguration:\n                  nodeRegistration:\n                    kubeletExtraArgs:\n                      cgroup-driver: cgroupfs\n                      eviction-hard: nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%\n        - apiVersion: cluster.x-k8s.io/v1beta1\n          kind: MachineDeployment\n          metadata:\n            name: "${CLUSTER_NAME}-md-0"\n            namespace: "${NAMESPACE}"\n          spec:\n            clusterName: "${CLUSTER_NAME}"\n            replicas: "${WORKER_MACHINE_COUNT}"\n            selector:\n              matchLabels: null\n            template:\n              spec:\n                bootstrap:\n                  configRef:\n                    apiVersion: bootstrap.cluster.x-k8s.io/v1beta1\n                    kind: KubeadmConfigTemplate\n                    name: "${CLUSTER_NAME}-md-0"\n                    namespace: "${NAMESPACE}"\n                clusterName: "${CLUSTER_NAME}"\n                infrastructureRef:\n                  apiVersion: infrastructure.cluster.x-k8s.io/v1beta1\n                  kind: DockerMachineTemplate\n                  name: "${CLUSTER_NAME}-md-0"\n                  namespace: "${NAMESPACE}"\n                version: "${KUBERNETES_VERSION}"\n'}}]);