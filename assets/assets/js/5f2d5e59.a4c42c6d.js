"use strict";(self.webpackChunkweave_gitops_docs=self.webpackChunkweave_gitops_docs||[]).push([[80203],{8971:(e,t,a)=>{a.d(t,{Z:()=>i});var n=a(67294),r=a(88746);a(52426);const l={fontSize:16,marginLeft:4,fontVariant:"all-small-caps"};function i(e){let{tiers:t}=e;return n.createElement(r.Z,{title:`This feature is a available on ${t}.`,style:l},t)}},29819:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>N,contentTitle:()=>v,default:()=>w,frontMatter:()=>f,metadata:()=>b,toc:()=>y});var n=a(87462),r=a(67294),l=a(3905),i=a(71125),o=a(32342),s=a(8971),p=a(77823),u=a(19666);function c(e){let{localPath:t,hostedPath:a,content:n}=e;return r.createElement(r.Fragment,null,r.createElement(u.Z,null,(()=>r.createElement(p.Z,{className:"language-bash"},"curl -o ",t," ",window.location.protocol,"//",window.location.host,a))),r.createElement(p.Z,{title:t,className:"language-yaml"},n))}var d=a(74354),m=a(17779),h=a(87585),g=a(65719);const k=a.p+"assets/files/example-enterprise-helm-3f50daa0331ddf234601bcf6985f5b37.yaml",f={title:"Install Weave GitOps Enterprise",hide_title:!0,pagination_next:"enterprise/getting-started/releases-enterprise"},v=void 0,b={unversionedId:"enterprise/getting-started/install-enterprise",id:"version-0.26.0/enterprise/getting-started/install-enterprise",title:"Install Weave GitOps Enterprise",description:"Install Weave GitOps Enterprise",source:"@site/versioned_docs/version-0.26.0/enterprise/getting-started/install-enterprise.mdx",sourceDirName:"enterprise/getting-started",slug:"/enterprise/getting-started/install-enterprise",permalink:"/docs/0.26.0/enterprise/getting-started/install-enterprise",draft:!1,editUrl:"https://github.com/weaveworks/weave-gitops/edit/main/website/versioned_docs/version-0.26.0/enterprise/getting-started/install-enterprise.mdx",tags:[],version:"0.26.0",frontMatter:{title:"Install Weave GitOps Enterprise",hide_title:!0,pagination_next:"enterprise/getting-started/releases-enterprise"},sidebar:"docs",previous:{title:"Introduction to Weave GitOps Enterprise",permalink:"/docs/0.26.0/enterprise/getting-started/intro-enterprise"},next:{title:"Enterprise Releases",permalink:"/docs/0.26.0/enterprise/getting-started/releases-enterprise"}},N={},y=[{value:'Install Weave GitOps Enterprise<TierLabel tiers="Enterprise" />',id:"install-weave-gitops-enterprise",level:2},{value:"Prep Step: Create a Repository",id:"prep-step-create-a-repository",level:3},{value:"1. Set up a Management Cluster with <code>flux</code>",id:"1-set-up-a-management-cluster-with-flux",level:3},{value:"1.1 We start by creating a kind-config",id:"11-we-start-by-creating-a-kind-config",level:5},{value:"1.2 Start your kind cluster using the configuration above and Kubernetes v1.23.6",id:"12-start-your-kind-cluster-using-the-configuration-above-and-kubernetes-v1236",level:5},{value:"1.1 Prepare IAM for installation",id:"11-prepare-iam-for-installation",level:5},{value:"1.2 Create the cluster",id:"12-create-the-cluster",level:5},{value:"1.3 Add cluster to kubeconfig",id:"13-add-cluster-to-kubeconfig",level:5},{value:"Install Flux onto your cluster with the <code>flux bootstrap</code> command",id:"install-flux-onto-your-cluster-with-the-flux-bootstrap-command",level:5},{value:"2. Install a CAPI provider",id:"2-install-a-capi-provider",level:3},{value:"3. Apply the entitlements secret",id:"3-apply-the-entitlements-secret",level:3},{value:"4. Configure access for writing to git from the UI",id:"4-configure-access-for-writing-to-git-from-the-ui",level:3},{value:"5. Configure and Commit",id:"5-configure-and-commit",level:3},{value:"<code>values.config.capi.repositoryURL</code>",id:"valuesconfigcapirepositoryurl",level:4},{value:"<code>values.config.capi.repositoryPath</code>",id:"valuesconfigcapirepositorypath",level:4},{value:"<code>values.config.capi.repositoryClustersPath</code>",id:"valuesconfigcapirepositoryclusterspath",level:4},{value:"(Optional) Install policy agent",id:"optional-install-policy-agent",level:4},{value:"6. Configure password",id:"6-configure-password",level:3},{value:"7. Install the CLI",id:"7-install-the-cli",level:3},{value:"Next steps",id:"next-steps",level:2},{value:"(Optional) Install the Terraform Controller",id:"optional-install-the-terraform-controller",level:3}],C={toc:y};function w(e){let{components:t,...a}=e;return(0,l.kt)("wrapper",(0,n.Z)({},C,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"install-weave-gitops-enterprise"},"Install Weave GitOps Enterprise",(0,l.kt)(s.Z,{tiers:"Enterprise",mdxType:"TierLabel"})),(0,l.kt)("admonition",{type:"info"},(0,l.kt)("p",{parentName:"admonition"},"To purchase an entitlement to Weave GitOps Enterprise, please contact ",(0,l.kt)("a",{parentName:"p",href:"mailto:sales@weave.works"},"sales@weave.works"),".")),(0,l.kt)("p",null,"Follow the instructions on this page to:"),(0,l.kt)(g.Z,{toc:(()=>{const e=y.slice(y.findIndex((e=>"install-weave-gitops-enterprise"==e.id))+1);return e.slice(0,e.findIndex((e=>"2"==e.level)))})(),mdxType:"TOCInline"}),(0,l.kt)("admonition",{type:"tip"},(0,l.kt)("p",{parentName:"admonition"},"There is no need to install the open source version of Weave GitOps before installing Weave GitOps Enterprise.")),(0,l.kt)("h3",{id:"prep-step-create-a-repository"},"Prep Step: Create a Repository"),(0,l.kt)("p",null,"Create a new private GitHub repository and give it a name. We'll call our repo ",(0,l.kt)("inlineCode",{parentName:"p"},"fleet-infra"),"."),(0,l.kt)("p",null,"Set up a Git client for your private repo. For GitHub, see their docs on ",(0,l.kt)("a",{parentName:"p",href:"https://docs.github.com/en/get-started/getting-started-with-git/setting-your-username-in-git#setting-your-git-username-for-every-repository-on-your-computer"},"setting your username")," and ",(0,l.kt)("a",{parentName:"p",href:"https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-personal-account-on-github/managing-email-preferences/setting-your-commit-email-address#setting-your-email-address-for-every-repository-on-your-computer"},"setting your email address"),"."),(0,l.kt)("h3",{id:"1-set-up-a-management-cluster-with-flux"},"1. Set up a Management Cluster with ",(0,l.kt)("inlineCode",{parentName:"h3"},"flux")),(0,l.kt)("p",null,"These steps reflect ",(0,l.kt)("a",{parentName:"p",href:"https://fluxcd.io/flux/"},"Flux"),"\u2019s architecture and operations. "),(0,l.kt)("p",null,"To get you started, we'll cover:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"kind")," as our management cluster with the ",(0,l.kt)("em",{parentName:"li"},"CAPD")," provider"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"EKS")," as our management cluster with the ",(0,l.kt)("em",{parentName:"li"},"CAPA")," provider")),(0,l.kt)("p",null,"Note that Weave GitOps Enterprise supports any combination of management cluster and CAPI provider."),(0,l.kt)(i.Z,{groupId:"infrastructure",default:!0,mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"kind",label:"kind",mdxType:"TabItem"},(0,l.kt)("h5",{id:"11-we-start-by-creating-a-kind-config"},"1.1 We start by creating a kind-config"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="kind-config.yaml"',title:'"kind-config.yaml"'},"kind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n  - role: control-plane\n    extraMounts:\n      - hostPath: /var/run/docker.sock\n        containerPath: /var/run/docker.sock\n")),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"extraMounts")," enable the Docker CAPI provider (CAPD) to talk to the host docker."),(0,l.kt)("h5",{id:"12-start-your-kind-cluster-using-the-configuration-above-and-kubernetes-v1236"},"1.2 Start your kind cluster using the configuration above and Kubernetes v1.23.6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kind create cluster --config kind-config.yaml --image=kindest/node:v1.23.6\n"))),(0,l.kt)(o.Z,{value:"eks",label:"EKS",mdxType:"TabItem"},(0,l.kt)("h5",{id:"11-prepare-iam-for-installation"},"1.1 Prepare IAM for installation"),(0,l.kt)("p",null,"Cluster API needs special permissions in AWS. Use the ",(0,l.kt)("inlineCode",{parentName:"p"},"clusterawsadm")," command below to roll out a CloudStack and install the permissions into your AWS account. Although the CloudStack is bound to a region, the resulting permissions are globally scoped. You can use any AWS Region that you have access to. "),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"clusterawsadm")," command takes an AWSIAMConfiguration file. We have provided a working example for you:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="eks-config.yaml"',title:'"eks-config.yaml"'},"apiVersion: bootstrap.aws.infrastructure.cluster.x-k8s.io/v1beta1\nkind: AWSIAMConfiguration\nspec:\n  bootstrapUser:\n    enable: true\n  eks:\n    iamRoleCreation: false # Set to true if you plan to use the EKSEnableIAM feature flag to enable automatic creation of IAM roles\n    defaultControlPlaneRole:\n      disable: false # Set to false to enable creation of the default control plane role\n    managedMachinePool:\n      disable: false # Set to false to enable creation of the default node pool role\n")),(0,l.kt)("p",null,"Run the ",(0,l.kt)("inlineCode",{parentName:"p"},"clusterawsadm")," command to create the IAM group."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"$ clusterawsadm bootstrap iam create-cloudformation-stack --config eks-config.yaml --region $REGION\n")),(0,l.kt)("p",null,"Create an IAM User. This user will be used as a kind of service account. Assign the newly created group to this user. The group name will be something like: ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster-api-provider-aws-s-AWSIAMGroupBootstrapper-XXXX"),". Create a secret for the newly created IAM user."),(0,l.kt)("h5",{id:"12-create-the-cluster"},"1.2 Create the cluster"),(0,l.kt)("p",null,"In testing, we used the following values:\n",(0,l.kt)("inlineCode",{parentName:"p"},"$INSTANCESIZE")," : t3.large\n",(0,l.kt)("inlineCode",{parentName:"p"},"$NUMOFNODES")," : 2\n",(0,l.kt)("inlineCode",{parentName:"p"},"$MINNODES")," : 2\n",(0,l.kt)("inlineCode",{parentName:"p"},"$MAXNODES")," : 6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'eksctl create cluster -n "$CLUSTERNAME" -r "$REGION" --nodegroup-name workers -t $INSTANCESIZE --nodes $NUMOFNODES --nodes-min $MINNODES --nodes-max $MAXNODES --ssh-access --alb-ingress-access\n')),(0,l.kt)("h5",{id:"13-add-cluster-to-kubeconfig"},"1.3 Add cluster to kubeconfig"),(0,l.kt)("p",null,"Once the cluster is created, add the cluster to your ",(0,l.kt)("inlineCode",{parentName:"p"},"kubeconfig"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'aws eks --region "$REGION" update-kubeconfig --name "$CLUSTERNAME"\n')))),(0,l.kt)("h5",{id:"install-flux-onto-your-cluster-with-the-flux-bootstrap-command"},"Install Flux onto your cluster with the ",(0,l.kt)("inlineCode",{parentName:"h5"},"flux bootstrap")," command"),(0,l.kt)(i.Z,{groupId:"infrastructure",default:!0,mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"github",label:"GITHUB",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"flux bootstrap github \\\n  --owner=<github username> \\\n  --repository=fleet-infra \\\n  --branch=main \\\n  --path=./clusters/management \\\n  --personal\n  --components-extra image-reflector-controller,image-automation-controller\n"))),(0,l.kt)(o.Z,{value:"gitlab",label:"GITLAB",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"flux bootstrap gitlab \\\n  --owner=<gitlab username> \\\n  --repository=fleet-infra \\\n  --branch=main \\\n  --path=./clusters/management \\\n  --personal\n")))),(0,l.kt)("p",null,"Your private GitHub repo should have a clusters/management folder that includes the manifests Flux needs to operate, and that also generates a key value pair for Flux to access the repo."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"owner"),"      - The username (or organization) of the git repository"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"repository")," - Git repository name"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"branch"),'     - Git branch (default "main")'),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"path"),"       - Path relative to the repository root; when specified, the cluster sync will be scoped to this path"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"personal"),"   - If set, the owner is assumed to be a repo user")),(0,l.kt)("p",null,"Go ",(0,l.kt)("a",{parentName:"p",href:"https://fluxcd.io/docs/cmd/"},"here")," for more information about ",(0,l.kt)("inlineCode",{parentName:"p"},"flux")," and the ",(0,l.kt)("inlineCode",{parentName:"p"},"flux bootstrap")," command. "),(0,l.kt)("admonition",{title:"At this point your Flux management cluster should be running. Take a look at the repository you created earlier.",type:"note"}),(0,l.kt)("h3",{id:"2-install-a-capi-provider"},"2. Install a CAPI provider"),(0,l.kt)("admonition",{type:"note"},(0,l.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,l.kt)("inlineCode",{parentName:"mdxAdmonitionTitle"},"clusterctl")," versions"),(0,l.kt)("p",{parentName:"admonition"},"Download a specific version of clusterctl from the ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-sigs/cluster-api/releases"},"releases page"),". We've tested the example templates provided in this guide with ",(0,l.kt)("inlineCode",{parentName:"p"},"clusterctl")," version ",(0,l.kt)("inlineCode",{parentName:"p"},"1.1.3"),". You might need to use a different version, depending on the CAPI provider you plan to use.")),(0,l.kt)("p",null,"You must install a CAPI provider to provision Kubernetes clusters. Visit the ",(0,l.kt)("a",{parentName:"p",href:"/docs/0.26.0/cluster-management/cluster-api-providers"},"Cluster API Providers")," page for more details on providers."),(0,l.kt)("p",null,"Here we'll continue with our example instructions for CAPD and CAPA."),(0,l.kt)(i.Z,{groupId:"infrastructure",default:!0,mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"kind",label:"CAPD (kind)",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Enable support for `ClusterResourceSet`s for automatically installing CNIs\nexport EXP_CLUSTER_RESOURCE_SET=true\n\nclusterctl init --infrastructure docker\n"))),(0,l.kt)(o.Z,{value:"eks",label:"CAPA (EKS)",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"export EXP_EKS=true\nexport EXP_MACHINE_POOL=true\nexport CAPA_EKS_IAM=true\nexport EXP_CLUSTER_RESOURCE_SET=true\n\nclusterctl init --infrastructure aws\n")))),(0,l.kt)("h3",{id:"3-apply-the-entitlements-secret"},"3. Apply the entitlements secret"),(0,l.kt)("p",null,"Contact ",(0,l.kt)("a",{parentName:"p",href:"mailto:sales@weave.works"},"sales@weave.works")," for a valid entitlements secret. Then apply it to the cluster:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f entitlements.yaml\n")),(0,l.kt)("h3",{id:"4-configure-access-for-writing-to-git-from-the-ui"},"4. Configure access for writing to git from the UI"),(0,l.kt)(i.Z,{groupId:"git-provider",default:!0,mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"github",label:"GitHub",mdxType:"TabItem"},"GitHub requires no additional configuration for OAuth git access"),(0,l.kt)(o.Z,{value:"gitlab",label:"GitLab",mdxType:"TabItem"},(0,l.kt)("p",null,"Create a GitLab OAuth application that will request ",(0,l.kt)("inlineCode",{parentName:"p"},"api")," permissions to create pull requests on the user's behalf."),(0,l.kt)("p",null,"Follow the ",(0,l.kt)("a",{parentName:"p",href:"https://docs.gitlab.com/ee/integration/oauth_provider.html"},"GitLab docs"),"."),(0,l.kt)("p",null,"The application should have at least these scopes:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"api")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"openid")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"email")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"profile"))),(0,l.kt)("p",null,"Add callback URLs to the application for each address the UI will be exposed on, e.g.:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"https://localhost:8000/oauth/gitlab")," For port-forwarding and testing"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"https://git.example.com/oauth/gitlab")," For production use")),(0,l.kt)("p",null,"Save your application and take note of the ",(0,l.kt)("strong",{parentName:"p"},"Client ID")," and ",(0,l.kt)("strong",{parentName:"p"},"Client Secret"),". Save\nthem into the ",(0,l.kt)("inlineCode",{parentName:"p"},"git-provider-credentials")," secret, along with:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"GIT_HOST_TYPES")," to tell WGE that the host is gitlab"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"GITLAB_HOSTNAME")," where the OAuth app is hosted")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Replace values")," in this snippet and run:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl create secret generic git-provider-credentials --namespace=flux-system \\\n  --from-literal="GITLAB_CLIENT_ID=13457" \\\n  --from-literal="GITLAB_CLIENT_SECRET=24680" \\\n  --from-literal="GITLAB_HOSTNAME=git.example.com" \\\n  --from-literal="GIT_HOST_TYPES=git.example.com=gitlab"\n'))),(0,l.kt)(o.Z,{value:"bitbucket-server",label:"BitBucket Server",mdxType:"TabItem"},(0,l.kt)("p",null,"Create a new ",(0,l.kt)("a",{parentName:"p",href:"https://confluence.atlassian.com/bitbucketserver/configure-an-incoming-link-1108483657.html"},"incoming application link")," from\nthe BitBucket administration dashboard. You will be asked to enter a unique name and the redirect URL for the external application. The redirect URL\nshould be set to ",(0,l.kt)("inlineCode",{parentName:"p"},"<WGE dashboard URL>/oauth/bitbucketserver"),". You will also need to select permissions for the application. The minimum set of\npermissions needed for WGE to create pull requests on behalf of users is ",(0,l.kt)("inlineCode",{parentName:"p"},"Repositories - Write"),". An example of configuring these settings is shown below."),(0,l.kt)("figure",null,(0,l.kt)("img",{src:d.Z,width:"500"}),(0,l.kt)("figcaption",null,"Configuring a new incoming application link")),(0,l.kt)("p",null,"Save your application and take note of the ",(0,l.kt)("strong",{parentName:"p"},"Client ID")," and ",(0,l.kt)("strong",{parentName:"p"},"Client Secret"),". Save\nthem into the ",(0,l.kt)("inlineCode",{parentName:"p"},"git-provider-credentials")," secret, along with:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"GIT_HOST_TYPES")," to tell WGE that the host is bitbucket-server"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"BITBUCKET_SERVER_HOSTNAME")," where the OAuth app is hosted")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Replace values")," in this snippet and run:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl create secret generic git-provider-credentials --namespace=flux-system \\\n  --from-literal="BITBUCKET_SERVER_CLIENT_ID=13457" \\\n  --from-literal="BITBUCKET_SERVER_CLIENT_SECRET=24680" \\\n  --from-literal="BITBUCKET_SERVER_HOSTNAME=git.example.com" \\\n  --from-literal="GIT_HOST_TYPES=git.example.com=bitbucket-server"\n')),(0,l.kt)("p",null,"If the secret is already present, use the following command to update it using your default editor:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl edit secret generic git-provider-credentials --namespace=flux-system\n")),(0,l.kt)("admonition",{type:"info"},(0,l.kt)("p",{parentName:"admonition"},"If BitBucket Server is running on the default port (7990), make sure you include the port number in the values of the secret. For example: ",(0,l.kt)("inlineCode",{parentName:"p"},"GIT_HOST_TYPES=git.example.com:7990=bitbucket-server")))),(0,l.kt)(o.Z,{value:"azure-devops",label:"Azure DevOps",mdxType:"TabItem"},(0,l.kt)("p",null,"Navigate to ",(0,l.kt)("a",{parentName:"p",href:"https://app.vsaex.visualstudio.com/app/register"},"https://app.vsaex.visualstudio.com/app/register")," and register a new application, as explained in the ",(0,l.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/devops/integrate/get-started/authentication/oauth?view=azure-devops#1-register-your-app"},"docs"),". Set the authorization callback URL and select which scopes to grant. Set the callback URL to ",(0,l.kt)("inlineCode",{parentName:"p"},"<WGE dashboard URL>/oauth/azuredevops"),". "),(0,l.kt)("p",null,"Select the ",(0,l.kt)("inlineCode",{parentName:"p"},"Code (read and write)")," scope from the list. This is necessary so that WGE can create pull requests on behalf of users. An example of configuring these settings is shown below."),(0,l.kt)("figure",null,(0,l.kt)("img",{src:m.Z}),(0,l.kt)("figcaption",null,"Creating a new application")),(0,l.kt)("p",null,"After creating your application, you will be presented with the application settings. Take note of the ",(0,l.kt)("inlineCode",{parentName:"p"},"App ID")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"Client Secret")," values\u2014you will use them to configure WGE."),(0,l.kt)("figure",null,(0,l.kt)("img",{src:h.Z}),(0,l.kt)("figcaption",null,"Application settings")),(0,l.kt)("p",null,"In your cluster, create a secret named ",(0,l.kt)("inlineCode",{parentName:"p"},"git-provider-credentials")," that contains the ",(0,l.kt)("inlineCode",{parentName:"p"},"App ID")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"Client Secret")," values from the newly created application."),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Replace values")," in this snippet and run:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl create secret generic git-provider-credentials --namespace=flux-system \\\n  --from-literal="AZURE_DEVOPS_CLIENT_ID=<App ID value>" \\\n  --from-literal="AZURE_DEVOPS_CLIENT_SECRET=<Client Secret value>"\n')),(0,l.kt)("p",null,"WGE is now configured to ask users for authorization the next time a pull request must be created as part of using a template. Note that each user can view and manage which applications they have authorized by navigating to ",(0,l.kt)("a",{parentName:"p",href:"https://app.vsaex.visualstudio.com/me"},"https://app.vsaex.visualstudio.com/me"),"."))),(0,l.kt)("h3",{id:"5-configure-and-commit"},"5. Configure and Commit"),(0,l.kt)("p",null,"We deploy WGE via a Helm chart. We'll save and adapt the below template before committing it in Git to a Flux-reconciled path."),(0,l.kt)("p",null,"Clone the newly created repo locally. We're gonna add some things!"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"git clone git@<provider>:<username>/fleet-infra\ncd fleet-infra\n")),(0,l.kt)("p",null,"Download the helm-release to ",(0,l.kt)("inlineCode",{parentName:"p"},"clusters/management/weave-gitops-enterprise.yaml"),"."),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Expand to see file contents"),(0,l.kt)(c,{localPath:"clusters/management/weave-gitops-enterprise.yaml",hostedPath:k,content:"apiVersion: source.toolkit.fluxcd.io/v1beta2\nkind: HelmRepository\nmetadata:\n  name: weave-gitops-enterprise-charts\n  namespace: flux-system\nspec:\n  interval: 60m\n  secretRef:\n    name: weave-gitops-enterprise-credentials\n  url: https://charts.dev.wkp.weave.works/releases/charts-v3\n---\napiVersion: helm.toolkit.fluxcd.io/v2beta1\nkind: HelmRelease\nmetadata:\n  name: weave-gitops-enterprise\n  namespace: flux-system\nspec:\n  chart:\n    spec:\n      interval: 65m\n      chart: mccp\n      sourceRef:\n        kind: HelmRepository\n        name: weave-gitops-enterprise-charts\n        namespace: flux-system\n      version: 0.22.0\n  install:\n    crds: CreateReplace\n  upgrade:\n    crds: CreateReplace\n  interval: 50m\n  values:\n    # -- Configure TLS settings if needed\n    # tls:\n      # -- Can be disabled if TLS is handled by a user-provided ingress controller\n      # enabled: true\n      # -- optionally specify a TLS secret\n      # secretName: null\n    config:\n      capi:\n        repositoryURL: https://github.com/$GITHUB_USER/fleet-infra\n        # -- Can be changed depending on your git repo structure\n        # repositoryPath: ./clusters/management/clusters\n        # repositoryClustersPath: ./cluster\n      git:\n        type: github\n        # -- Change if using on-prem github/gitlab\n        # hostname: https://github.com\n",mdxType:"CurlCodeBlock"})),(0,l.kt)("p",null,"Once you have copied the above file, open and adjust the following configuration\noptions:"),(0,l.kt)("h4",{id:"valuesconfigcapirepositoryurl"},(0,l.kt)("inlineCode",{parentName:"h4"},"values.config.capi.repositoryURL")),(0,l.kt)("p",null,"Ensure this has been set to your repository URL."),(0,l.kt)("h4",{id:"valuesconfigcapirepositorypath"},(0,l.kt)("inlineCode",{parentName:"h4"},"values.config.capi.repositoryPath")),(0,l.kt)("p",null,"By default, WGE will create new clusters in the ",(0,l.kt)("inlineCode",{parentName:"p"},"clusters/management/clusters")," path.\nYou can configure it with ",(0,l.kt)("inlineCode",{parentName:"p"},"values.config.capi.repositoryPath"),".\nYou might what to change it to ",(0,l.kt)("inlineCode",{parentName:"p"},"clusters/my-cluster/cluster")," if you configured Flux to reconcile ",(0,l.kt)("inlineCode",{parentName:"p"},"./clusters/my-cluster")," instead."),(0,l.kt)("h4",{id:"valuesconfigcapirepositoryclusterspath"},(0,l.kt)("inlineCode",{parentName:"h4"},"values.config.capi.repositoryClustersPath")),(0,l.kt)("p",null,"The other important path to configure is where you'll store applications and workloads run on the new cluster.\nBy default this is ",(0,l.kt)("inlineCode",{parentName:"p"},"./clusters"),". When a new cluster is specified, any selected profiles will be written to ",(0,l.kt)("inlineCode",{parentName:"p"},"./clusters/{.namespace}/{.clusterName}/profiles.yaml"),".\nWhen the new cluster is bootstrapped, Flux will sync the ",(0,l.kt)("inlineCode",{parentName:"p"},"./clusters/{.namespace}/{.clusterName}")," path."),(0,l.kt)("h4",{id:"optional-install-policy-agent"},"(Optional) Install policy agent"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"/docs/0.26.0/policy/intro"},"Policy agent")," comes packaged with the WGE chart. To install it, set the following values:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"values.policy-agent.enabled"),": set to true to install the agent with WGE"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"values.policy-agent.config.accountId"),": organization name, used as identifier"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"values.policy-agent.config.clusterId"),": unique identifier for the cluster")),(0,l.kt)("p",null,"Commit and push all the files"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'git add clusters/management/weave-gitops-enterprise.yaml\ngit commit -m "Deploy Weave GitOps Enterprise"\ngit push\n')),(0,l.kt)("p",null,"Flux will reconcile the helm-release and WGE will be deployed into the cluster. You can check the ",(0,l.kt)("inlineCode",{parentName:"p"},"flux-system")," namespace to verify all pods are running."),(0,l.kt)("h3",{id:"6-configure-password"},"6. Configure password"),(0,l.kt)("p",null,"To login to the WGE UI, generate a bcrypt hash for your chosen password and store it as a secret in the Kubernetes cluster."),(0,l.kt)("p",null,"There are several different ways to generate a bcrypt hash. This guide uses ",(0,l.kt)("inlineCode",{parentName:"p"},"gitops get bcrypt-hash")," from our CLI, which you can install with ",(0,l.kt)("a",{parentName:"p",href:"#gitops-cli"},"these instructions"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'PASSWORD="<Make up and insert a brand-new password here. Keeping the quotes, but remove the brackets.>"\necho -n $PASSWORD | gitops get bcrypt-hash\n$2a$10$OS5NJmPNEb13UgTOSKnMxOWlmS7mlxX77hv4yAiISvZ71Dc7IuN3q\n')),(0,l.kt)("p",null,"Use the hashed output to create a Kubernetes username/password secret. Insert it in the last line of this command, replacing what\u2019s currently shown within the quotation marks ('$2a$.......')."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create secret generic cluster-user-auth \\\n  --namespace flux-system \\\n  --from-literal=username=wego-admin \\\n  --from-literal=password='$2a$.......'\n")),(0,l.kt)("h3",{id:"7-install-the-cli"},"7. Install the CLI"),(0,l.kt)("p",null,"Install the Weave GitOps Enterprise CLI tool.\nYou can use brew or curl."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"brew install weaveworks/tap/gitops-ee\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"curl --silent --location \"https://artifacts.wge.dev.weave.works/releases/bin/0.22.0/gitops-$(uname | tr '[:upper:]' '[:lower:]')-$(uname -m).tar.gz\" | tar xz -C /tmp\nsudo mv /tmp/gitops /usr/local/bin\ngitops version\n")),(0,l.kt)("h2",{id:"next-steps"},"Next steps"),(0,l.kt)("p",null,"Check out:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"/docs/0.26.0/cluster-management/getting-started"},"Cluster Management - Getting started")," to create your first CAPI Cluster with ",(0,l.kt)("inlineCode",{parentName:"li"},"kind"),"/CAPD."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"/docs/0.26.0/guides/deploying-capa"},"Deploying CAPA with EKS")," to create your first CAPI Cluster with EKS/CAPA.")),(0,l.kt)("h3",{id:"optional-install-the-terraform-controller"},"(Optional) Install the Terraform Controller"),(0,l.kt)("p",null,"The ",(0,l.kt)("a",{parentName:"p",href:"https://weaveworks.github.io/tf-controller/"},"Terraform Controller")," is a controller for Flux to reconcile Terraform resources in a GitOps way."),(0,l.kt)("p",null,"With Flux and the TF-Controller, WGE makes it easy to add Terraform templates to clusters and continuously reconcile any changes made to the Terraform source manifest."),(0,l.kt)("p",null,"Check out our guide on ",(0,l.kt)("a",{parentName:"p",href:"/docs/0.26.0/guides/using-terraform-templates"},"how to use Terraform templates"),". Then try your hands at using it with the RDS example!"),(0,l.kt)("p",null,"Install the TF-Controller to a cluster using Helm:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"# Add tf-controller helm repository\nhelm repo add tf-controller https://weaveworks.github.io/tf-controller/\n\n# Install tf-controller\nhelm upgrade -i tf-controller tf-controller/tf-controller \\\n    --namespace flux-system\n")),(0,l.kt)("p",null,"Consult the TF-Controller ",(0,l.kt)("a",{parentName:"p",href:"https://weaveworks.github.io/tf-controller/getting_started/"},"Installation documentation")," for more details on which parameters are configurable and how to install a specific version."))}w.isMDXComponent=!0},87585:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/oauth-azure-devops-success-4806f495e958a093e7e20df952e2026e.png"},17779:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/oauth-azure-devops-fedd005afed739e13a4a8bbd676c3928.png"},74354:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/oauth-bitbucket-dd2f409a75d5fa495765537b2c3f6f17.png"}}]);